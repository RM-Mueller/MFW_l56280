---
title: "Modelling the Impact of Data Anomalies on Tourism Demand Forecasts"
author: "Rosanna Mueller"
date: "February 2023"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 5
    number_sections: yes
    theme: united
    toc_float:
      smooth_scroll: no
    df_print: paged
  pdf_document:
    toc: yes
    toc_depth: '5'
  word_document:
    toc: yes
    toc_depth: '5'
subtitle: Master's Final Work
always_allow_html: yes
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.align='center') # include all code chunks in the final rendered version + hide warning messages + align figures in center
```

```{r, include=FALSE}
# Import libraries
library("readxl")
library("tidyverse")
library("fpp3")
library("kableExtra")

library("fable.prophet")
library("Rcpp")
library("fabletools")

# Change locale in R to get the month name in English
Sys.setlocale("LC_TIME", "English")
```

# Exploratory Data Analysis

## Overnight Stays per Region from 2000 to 2022

```{r}
# Import excel file and create tibble "tourism" with all data
tourism <- read_excel("C:\\Users\\Rosan\\OneDrive - ISEG\\# Masterthesis\\My MFW\\MonthlyOvernightStays_perRegion.xlsx",sheet = "2000") %>%
  pivot_longer(-Region, values_to = "Overnight_Stays") %>%
  mutate(Month = paste(name, "2000")) %>%
  select(-name)

for (i in 2001:2022){
  tourism_next_year <- read_excel("C:\\Users\\Rosan\\OneDrive - ISEG\\# Masterthesis\\My MFW\\MonthlyOvernightStays_perRegion.xlsx",sheet = as.character(i)) %>%
    pivot_longer(-Region, values_to = "Overnight_Stays") %>%
    mutate(Month = paste(name, as.character(i))) %>%
    select(-name)
  tourism <- rbind(tourism, tourism_next_year)}

rm(tourism_next_year) # remove variable "tourism_next_year" from R environment

# Transform tibble "tourism" to tsibble
tourism <- tourism %>%
  mutate (Month = yearmonth(Month)) %>%
  as_tsibble(index = Month, key = Region) %>%
  filter(!is.na(Overnight_Stays)) %>%
  select(Month, Region, Overnight_Stays)

# Change Region Names to English
tourism["Region"][tourism["Region"] == "Açores"] <- "Azores"
tourism["Region"][tourism["Region"] == "A.M. Lisboa"] <- "Lisbon M.A."
tourism["Region"][tourism["Region"] == "Centro"] <- "Central"
tourism["Region"][tourism["Region"] == "Norte"] <- "North"

# Show tsibble
tourism %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Monthly Number of Overnight Stays per Region: 2000-2022</span>", format.args = list(big.mark = ","), align = "lcc") %>%
  column_spec(2:3, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

## Time Series Plots

```{r}
# Show time series of all regions in one plot
tourism %>%
  filter(Region != "Total Portugal") %>%
  autoplot(Overnight_Stays) +
  ggtitle("All Regions - Overnight Stays")

# Show all time series in a Facet Grid
tourism %>%
  filter(Region != "Total Portugal") %>%
  autoplot(Overnight_Stays) +
  facet_grid(Region~., scales = "free_y") +
  theme(strip.text.y = element_blank()) +
  ggtitle("All Regions - Overnight Stays")

# Show time series "Lisbon M.A."
tourism %>%
  filter(Region == "Lisbon M.A.") %>%
  autoplot(Overnight_Stays) +
  ggtitle("Lisbon M.A. - Overnight Stays")

# Show time series "Azores"
tourism %>%
  filter(Region == "Azores") %>%
  autoplot(Overnight_Stays) +
  ggtitle("Azores - Overnight Stays")

# Show time series "Alentejo"
tourism %>%
  filter(Region == "Alentejo") %>%
  autoplot(Overnight_Stays) +
  ggtitle("Alentejo - Overnight Stays")

# Show time series "Algarve"
tourism %>%
  filter(Region == "Algarve") %>%
  autoplot(Overnight_Stays) +
  ggtitle("Algarve - Overnight Stays")

# Show time series "Central"
tourism %>%
  filter(Region == "Central") %>%
  autoplot(Overnight_Stays) +
  ggtitle("Central - Overnight Stays")

# Show time series "Madeira"
tourism %>%
  filter(Region == "Madeira") %>%
  autoplot(Overnight_Stays) +
  ggtitle("Madeira - Overnight Stays")

# Show time series "North"
tourism %>%
  filter(Region == "North") %>%
  autoplot(Overnight_Stays) +
  ggtitle("North - Overnight Stays")

```

## Seasonal Differencing for 2020

```{r}
# Seasonal Difference March 2020
tourism %>%
  filter(Region != "Total Portugal") %>%
  mutate(SeasDiff_abs = difference(Overnight_Stays,12)) %>%
  filter_index("2020 Mar") %>%
  mutate(SeasDiff_rel = SeasDiff_abs/(Overnight_Stays-SeasDiff_abs)) %>%
  arrange(SeasDiff_rel) %>%
  as_tibble() %>%
  select(-Month) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Seasonal Difference March 2020</span>", digits = 4, format.args = list(big.mark = ","), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

# Seasonal Difference April 2020
tourism %>%
  filter(Region != "Total Portugal") %>%
  mutate(SeasDiff_abs = difference(Overnight_Stays,12)) %>%
  filter_index("2020 Apr") %>%
  mutate(SeasDiff_rel = SeasDiff_abs/(Overnight_Stays-SeasDiff_abs)) %>%
  arrange(SeasDiff_rel) %>%
  as_tibble() %>%
  select(-Month) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Seasonal Difference April 2020</span>", digits = 4, format.args = list(big.mark = ","), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

# Seasonal Difference May 2020
tourism %>%
  filter(Region != "Total Portugal") %>%
  mutate(SeasDiff_abs = difference(Overnight_Stays,12)) %>%
  filter_index("2020 May") %>%
  mutate(SeasDiff_rel = SeasDiff_abs/(Overnight_Stays-SeasDiff_abs)) %>%
  arrange(SeasDiff_rel) %>%
  as_tibble() %>%
  select(-Month) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Seasonal Difference May 2020</span>", digits = 4, format.args = list(big.mark = ","), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

# Seasonal Difference June 2020
tourism %>%
  filter(Region != "Total Portugal") %>%
  mutate(SeasDiff_abs = difference(Overnight_Stays,12)) %>%
  filter_index("2020 Jun") %>%
  mutate(SeasDiff_rel = SeasDiff_abs/(Overnight_Stays-SeasDiff_abs)) %>%
  arrange(SeasDiff_rel) %>%
  as_tibble() %>%
  select(-Month) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Seasonal Difference June 2020</span>", digits = 4, format.args = list(big.mark = ","), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

# Seasonal Difference July 2020
tourism %>%
  filter(Region != "Total Portugal") %>%
  mutate(SeasDiff_abs = difference(Overnight_Stays,12)) %>%
  filter_index("2020 Jul") %>%
  mutate(SeasDiff_rel = SeasDiff_abs/(Overnight_Stays-SeasDiff_abs)) %>%
  arrange(SeasDiff_rel) %>%
  as_tibble() %>%
  select(-Month) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Seasonal Difference July 2020</span>", digits = 4, format.args = list(big.mark = ","), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

# Mean relative Seasonal Difference: April - December 2020
tourism %>%
  filter(Region != "Total Portugal") %>%
  mutate(SeasDiff_abs = difference(Overnight_Stays,12)) %>%
  filter_index("Apr 2020" ~ "Dec 2020") %>%
  mutate(SeasDiff_rel = SeasDiff_abs/(Overnight_Stays-SeasDiff_abs)) %>%
  features(SeasDiff_rel, features = list(mean = mean)) %>%
  rename(Mean_SeasDiff_rel = mean) %>%
  arrange(Mean_SeasDiff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Mean rel. Seas. Difference: <br> April - December 2020</span>", digits = 4, format.args = list(big.mark = ","), align = "lc") %>%
  column_spec(2, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

```

## Analysis of Residence Countries of Tourists per Region

```{r}
# Top 3 Residence Countries of Tourists in August 2019 per Region with Ratio

# Import data
residence_2019 <- read_excel("C:\\Users\\Rosan\\OneDrive - ISEG\\# Masterthesis\\My MFW\\MonthlyOvernightStays_withResidenceCountry_perRegion.xlsx",sheet = "2019_AllRegions") %>%
  select(c(Region, Residence_Country, August)) %>%
  arrange(desc(August)) %>%
  group_by(Region) %>%
  mutate(Ratio = August/sum(August)) %>%
  rename(Overnight_Stays = August) %>%
  slice(1:3)

# Change Region Names to English
residence_2019["Region"][residence_2019["Region"] == "Açores"] <- "Azores"
residence_2019["Region"][residence_2019["Region"] == "A.M. Lisboa"] <- "Lisbon M.A."
residence_2019["Region"][residence_2019["Region"] == "Centro"] <- "Central"
residence_2019["Region"][residence_2019["Region"] == "Norte"] <- "North"

# Change Residence Country Names to English
residence_2019["Residence_Country"][residence_2019["Residence_Country"] == "Outros Estrangeiros"] <- "Other Countries"
residence_2019["Residence_Country"][residence_2019["Residence_Country"] == "Espanha"] <- "Spain"
residence_2019["Residence_Country"][residence_2019["Residence_Country"] == "Alemanha"] <- "Germany"
residence_2019["Residence_Country"][residence_2019["Residence_Country"] == "EUA"] <- "USA"
residence_2019["Residence_Country"][residence_2019["Residence_Country"] == "França"] <- "France"
residence_2019["Residence_Country"][residence_2019["Residence_Country"] == "Reino Unido"] <- "United Kingdom"

# Output tibble in clear table
residence_2019 %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Top 3 Residence Countries of Tourists in August 2019</span>", digits = 4, format.args = list(big.mark = ","), align = "cccc") %>%
  column_spec(2:4,border_left = T) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  pack_rows("Lisbon M.A.", 1, 3) %>%
  pack_rows("Azores", 4, 6) %>%
    pack_rows("Alentejo", 7, 9) %>%
    pack_rows("Algarve", 10, 12) %>%
    pack_rows("Central", 13, 15) %>%
    pack_rows("Madeira", 16, 18) %>%
    pack_rows("North", 19, 21)
```

```{r}
# Ratio of Portuguese Tourists in Continental Regions in Aug 2019
residence_2019 %>%
  filter(!Region == ("Madeira"), !Region == ("Azores")) %>%
  filter(Residence_Country == "Portugal") %>%
  arrange(desc(Ratio)) %>%
  select(-Residence_Country) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Ratio of Portuguese Tourists in Continental Regions in Aug 2019</span>", digits = 4, format.args = list(big.mark = ","), align = "lcc") %>%
  column_spec(2:3, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

```{r}
# Top 3 Residence Countries of Tourists in August 2021 per Region with Ratio

# Import data
residence_2021 <- read_excel("C:\\Users\\Rosan\\OneDrive - ISEG\\# Masterthesis\\My MFW\\MonthlyOvernightStays_withResidenceCountry_perRegion.xlsx",sheet = "2021_AllRegions") %>%
  select(c(Region, Residence_Country, August)) %>%
  arrange(desc(August)) %>%
  group_by(Region) %>%
  mutate(Ratio = August/sum(August)) %>%
  rename(Overnight_Stays = August) %>%
  slice(1:3)

# Change Region Names to English
residence_2021["Region"][residence_2021["Region"] == "Açores"] <- "Azores"
residence_2021["Region"][residence_2021["Region"] == "A.M. Lisboa"] <- "Lisbon M.A."
residence_2021["Region"][residence_2021["Region"] == "Centro"] <- "Central"
residence_2021["Region"][residence_2021["Region"] == "Norte"] <- "North"

# Change Residence Country Names to English
residence_2021["Residence_Country"][residence_2021["Residence_Country"] == "Outros Estrangeiros"] <- "Other Countries"
residence_2021["Residence_Country"][residence_2021["Residence_Country"] == "Espanha"] <- "Spain"
residence_2021["Residence_Country"][residence_2021["Residence_Country"] == "Alemanha"] <- "Germany"
residence_2021["Residence_Country"][residence_2021["Residence_Country"] == "EUA"] <- "USA"
residence_2021["Residence_Country"][residence_2021["Residence_Country"] == "França"] <- "France"
residence_2021["Residence_Country"][residence_2021["Residence_Country"] == "Reino Unido"] <- "United Kingdom"

# Output tibble in clear table
residence_2021 %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Top 3 Residence Countries of Tourists in August 2021</span>", digits = 4, format.args = list(big.mark = ","), align = "cccc") %>%
  column_spec(2:4,border_left = T) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  pack_rows("Lisbon M.A.", 1, 3) %>%
  pack_rows("Azores", 4, 6) %>%
  pack_rows("Alentejo", 7, 9) %>%
  pack_rows("Algarve", 10, 12) %>%
  pack_rows("Central", 13, 15) %>%
  pack_rows("Madeira", 16, 18) %>%
  pack_rows("North", 19, 21)
```

```{r}
# Ratio of Portuguese Tourists in Continental Regions in Aug 2021
residence_2021 %>%
  filter(!Region == ("Madeira"), !Region == ("Azores")) %>%
  filter(Residence_Country == "Portugal") %>%
  arrange(desc(Ratio)) %>%
  select(-Residence_Country) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Ratio of Portuguese Tourists in Continental Regions in Aug 2021</span>", digits = 4, format.args = list(big.mark = ","), align = "lcc") %>%
  column_spec(2:3, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

## Seasonality and Trend of selected time series

```{r}
# Save time series of interest
tourism_madeira_until2019 <- tourism %>%
  filter(Region == "Madeira") %>%
  filter(year(Month) <= 2019)

tourism_madeira_until2022 <- tourism %>% filter(Region == "Madeira")

tourism_algarve_until2019 <- tourism %>%
  filter(Region == "Algarve") %>%
  filter(year(Month) <= 2019)

tourism_algarve_until2022 <- tourism %>% filter(Region == "Algarve")

tourism_alentejo_until2019 <- tourism %>%
  filter(Region == "Alentejo") %>%
  filter(year(Month) <= 2019)

tourism_alentejo_until2022 <- tourism %>% filter(Region == "Alentejo")
```

### Madeira

```{r}
# Show tsibble
tourism_madeira_until2022 %>%
  select(Month, Overnight_Stays) %>% 
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Monthly Number of Overnight Stays in Madeira: 2000-2022</span>", format.args = list(big.mark = ","), align = "lcc") %>%
  column_spec(2, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

#### Seasonal Subseries Plot

```{r}
# Plot Seasonal Subseries Plot
tourism_madeira_until2022 %>%
  gg_subseries(Overnight_Stays) +
  theme(strip.text.y = element_blank()) +
  ggtitle("Madeira - Seasonality of Overnight Stays")
```

#### Time Series Variation

```{r}
# Difference from December 2000 to August 2000
diff_2000 <- tourism_madeira_until2022 %>%
  mutate(Diff_to_August = difference(Overnight_Stays, 4)) %>%
  filter_index("2000 Dec")

# Difference from December 2019 to August 2019
diff_2019 <- tourism_madeira_until2022 %>%
  mutate(Diff_to_August = difference(Overnight_Stays, 4)) %>%
  filter_index("2019 Dec")

# Show in one table
bind_rows(diff_2000, diff_2019) %>%
  select(Month, Overnight_Stays, Diff_to_August) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Madeira's Seasonal Variation: 2000 vs. 2019</span>", digits = 2, format.args = list(big.mark = ","), align = "lcc") %>%
  column_spec(2:3, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  footnote("Diff_to_August = Diff between Dec and Aug of the same year")

rm(diff_2000, diff_2019) # remove variables from R environment
```

#### Trend Calculation

```{r}
# Absolute and relative annual Differences of Overnight Stays
tourism_madeira_until2022 %>%
  index_by(Year = year(Month)) %>%
  summarise(Sum_Overnight_Stays = sum(Overnight_Stays)) %>%
  mutate(Diff_abs = difference(Sum_Overnight_Stays, 1)) %>%
  mutate(Diff_rel = Diff_abs/(Sum_Overnight_Stays - Diff_abs)) %>%
  mutate(across(c("Sum_Overnight_Stays", "Diff_abs", "Diff_rel"), ~ format(.x, big.mark = ",", digits = 2))) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Abs. and rel. annual Differences of Overnight Stays in Madeira</span>", align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

```{r}
# Calculate Mean of relative annual Differences of Overnight Stays: 2001-2009
mean_diff_2001 <- tourism_madeira_until2022 %>%
  index_by(Year = year(Month)) %>%
  summarise(Sum_Overnight_Stays = sum(Overnight_Stays)) %>%
  mutate(Diff_abs = difference(Sum_Overnight_Stays, 1)) %>%
  mutate(Diff_rel = Diff_abs/(Sum_Overnight_Stays - Diff_abs)) %>%
  filter_index("2001", "2002","2003","2004","2005","2006","2007","2008", "2009") %>%
  select(Year, Diff_rel) %>%
  features(.var = Diff_rel, list(Mean_Diff_rel = mean)) %>%
  mutate(Year = "2000-2009")

# Calculate Mean of relative annual Differences of Overnight Stays: 2010-2019
mean_diff_2010 <- tourism_madeira_until2022 %>%
  index_by(Year = year(Month)) %>%
  summarise(Sum_Overnight_Stays = sum(Overnight_Stays)) %>%
  mutate(Diff_abs = difference(Sum_Overnight_Stays, 1)) %>%
  mutate(Diff_rel = Diff_abs/(Sum_Overnight_Stays - Diff_abs)) %>%
  filter_index("2010", "2011", "2012","2013","2014","2015","2016","2017","2018", "2019") %>%
  select(Year, Diff_rel) %>%
  features(.var = Diff_rel, list(Mean_Diff_rel = mean)) %>%
  mutate(Year = "2010-2019")

# Show results in one table
bind_rows(mean_diff_2001, mean_diff_2010) %>%
  select(Year, Mean_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Mean of rel. annual Differences of Overnight Stays</span>", digits = 4, format.args = list(big.mark = ","), align = "lc") %>%
  column_spec(2, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

rm(mean_diff_2001, mean_diff_2010) # remove variables from R environment
```

```{r}
# Calculate Seasonal Difference of months in 2022 to 2021 and 2019
tourism_madeira_until2022 %>%
  mutate(Year = year(Month)) %>%
  mutate(SeasDiff_to_2021_abs = difference(Overnight_Stays, 12)) %>%
  mutate(SeasDiff_to_2021_rel = SeasDiff_to_2021_abs/(Overnight_Stays-SeasDiff_to_2021_abs)) %>%
  mutate(SeasDiff_to_2019_abs = difference(Overnight_Stays, 36)) %>%
  mutate(SeasDiff_to_2019_rel = SeasDiff_to_2019_abs/(Overnight_Stays-SeasDiff_to_2019_abs)) %>%
  filter(Year == 2022) %>%
  select(Month, Overnight_Stays, SeasDiff_to_2021_abs, SeasDiff_to_2021_rel, SeasDiff_to_2019_abs, SeasDiff_to_2019_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Seasonal Differences of 2022 to 2021 & 2019</span>", digits = 4, format.args = list(big.mark = ","), align = "lccccc") %>%
  column_spec(2:6, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

#### STL Decomposition

```{r}
# Fit STL decomposition to data
dcmp_madeira <- tourism_madeira_until2022 %>%
  model(STL(Overnight_Stays))

 # Plot components
dcmp_madeira %>%
  components() %>%
  autoplot() +
  ggtitle("Madeira - STL decomposition")

# Superimpose trend on top of time series
tourism_madeira_until2022 %>%
  autoplot(Overnight_Stays, color = "gray") +
  autolayer(components(dcmp_madeira), trend, color = "red") +
  ggtitle("Madeira - Overnight Stays with superimposed Trend")
```

#### Time Series Plot: Detailed View

```{r}
# Create Time plot for period 2000-2022
tourism_madeira_until2022 %>%
  autoplot(Overnight_Stays) +
  ggtitle("Overnight Stays in Madeira: 2000-2022")

# Create Time plot for period 2000-2019
tourism_madeira_until2019 %>%
  autoplot(Overnight_Stays) +
  ggtitle("Overnight Stays in Madeira: 2000-2019")

# Create Time plot for period 2020-2022
tourism_madeira_until2022 %>%
  filter(year(Month) > 2019) %>%
  autoplot(Overnight_Stays) +
  ggtitle("Overnight Stays in Madeira: 2020-2022")
```

### Algarve

```{r}
# Show tsibble
tourism_algarve_until2022 %>%
  select(Month, Overnight_Stays) %>% 
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Monthly Number of Overnight Stays in Algarve: 2000-2022</span>", format.args = list(big.mark = ","), align = "lcc") %>%
  column_spec(2, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

#### Seasonal Subseries Plot

```{r}
# Plot Seasonal Subseries Plot
tourism_algarve_until2022 %>%
  gg_subseries(Overnight_Stays) +
  theme(strip.text.y = element_blank()) +
  ggtitle("Algarve - Seasonality of Overnight Stays")
```

#### Time Series Variation

```{r}
# Difference from December 2000 to August 2000
diff_2000 <- tourism_algarve_until2022 %>%
  mutate(Diff_to_August = difference(Overnight_Stays, 4)) %>%
  filter_index("2000 Dec")

# Difference from December 2019 to August 2019
diff_2019 <- tourism_algarve_until2022 %>%
  mutate(Diff_to_August = difference(Overnight_Stays, 4)) %>%
  filter_index("2019 Dec")

# Show in one table
bind_rows(diff_2000, diff_2019) %>%
  select(Month, Overnight_Stays, Diff_to_August) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Algarve's Seasonal Variation: 2000 vs. 2019</span>", digits = 2, format.args = list(big.mark = ","), align = "lcc") %>%
  column_spec(2:3, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  footnote("Diff_to_August = Diff between Dec and Aug of the same year")

rm(diff_2000, diff_2019) # remove variables from R environment
```

#### Trend Calculation

```{r}
# Absolute and relative annual Differences of Overnight Stays
tourism_algarve_until2022 %>%
  index_by(Year = year(Month)) %>%
  summarise(Sum_Overnight_Stays = sum(Overnight_Stays)) %>%
  mutate(Diff_abs = difference(Sum_Overnight_Stays, 1)) %>%
  mutate(Diff_rel = Diff_abs/(Sum_Overnight_Stays - Diff_abs)) %>%
  mutate(across(c("Sum_Overnight_Stays", "Diff_abs", "Diff_rel"), ~ format(.x, big.mark = ",", digits = 3))) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Abs. and rel. annual Differences of Overnight Stays in Algarve</span>", align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

```{r}
# Calculate Mean of relative annual Differences of Overnight Stays: 2001-2009
mean_diff_2001 <- tourism_algarve_until2022 %>%
  index_by(Year = year(Month)) %>%
  summarise(Sum_Overnight_Stays = sum(Overnight_Stays)) %>%
  mutate(Diff_abs = difference(Sum_Overnight_Stays, 1)) %>%
  mutate(Diff_rel = Diff_abs/(Sum_Overnight_Stays - Diff_abs)) %>%
  filter_index("2001", "2002","2003","2004","2005","2006","2007","2008", "2009") %>%
  select(Year, Diff_rel) %>%
  features(.var = Diff_rel, list(Mean_Diff_rel = mean)) %>%
  mutate(Year = "2000-2009")

# Calculate Mean of relative annual Differences of Overnight Stays: 2010-2019
mean_diff_2010 <- tourism_algarve_until2022 %>%
  index_by(Year = year(Month)) %>%
  summarise(Sum_Overnight_Stays = sum(Overnight_Stays)) %>%
  mutate(Diff_abs = difference(Sum_Overnight_Stays, 1)) %>%
  mutate(Diff_rel = Diff_abs/(Sum_Overnight_Stays - Diff_abs)) %>%
  filter_index("2010", "2011", "2012","2013","2014","2015","2016","2017","2018", "2019") %>%
  select(Year, Diff_rel) %>%
  features(.var = Diff_rel, list(Mean_Diff_rel = mean)) %>%
  mutate(Year = "2010-2019")

# Show results in one table
bind_rows(mean_diff_2001, mean_diff_2010) %>%
  select(Year, Mean_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Mean of rel. annual Differences of Overnight Stays</span>", digits = 4, format.args = list(big.mark = ","), align = "lc") %>%
  column_spec(2, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

rm(mean_diff_2001, mean_diff_2010) # remove variables from R environment
```

```{r}
# Calculate Seasonal Difference of months in 2022 to 2021 and 2019
tourism_algarve_until2022 %>%
  mutate(Year = year(Month)) %>%
  mutate(SeasDiff_to_2021_abs = difference(Overnight_Stays, 12)) %>%
  mutate(SeasDiff_to_2021_rel = SeasDiff_to_2021_abs/(Overnight_Stays-SeasDiff_to_2021_abs)) %>%
  mutate(SeasDiff_to_2019_abs = difference(Overnight_Stays, 36)) %>%
  mutate(SeasDiff_to_2019_rel = SeasDiff_to_2019_abs/(Overnight_Stays-SeasDiff_to_2019_abs)) %>%
  filter(Year == 2022) %>%
  select(Month, Overnight_Stays, SeasDiff_to_2021_abs, SeasDiff_to_2021_rel, SeasDiff_to_2019_abs, SeasDiff_to_2019_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Seasonal Differences of 2022 to 2021 & 2019</span>", digits = 4, format.args = list(big.mark = ","), align = "lccccc") %>%
  column_spec(2:6, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

#### STL Decomposition

```{r}
# Fit STL decomposition to data
dcmp_algarve <- tourism_algarve_until2022 %>%
  model(STL(Overnight_Stays))

 # Plot components
dcmp_algarve %>%
  components() %>%
  autoplot() +
  ggtitle("Algarve - STL decomposition")

# Superimpose trend on top of time series
tourism_algarve_until2022 %>%
  autoplot(Overnight_Stays, color = "gray") +
  autolayer(components(dcmp_algarve), trend, color = "red") +
  ggtitle("Algarve - Overnight Stays with superimposed Trend")
```

#### Time Series Plot: Detailed View

```{r}
# Create Time plot for period 2000-2022
tourism_algarve_until2022 %>%
  autoplot(Overnight_Stays) +
  ggtitle("Overnight Stays in Algarve: 2000-2022")

# Create Time plot for period 2000-2019
tourism_algarve_until2019 %>%
  autoplot(Overnight_Stays) +
  ggtitle("Overnight Stays in Algarve: 2000-2019")

# Create Time plot for period 2020-2022
tourism_algarve_until2022 %>%
  filter(year(Month) > 2019) %>%
  autoplot(Overnight_Stays) +
  ggtitle("Overnight Stays in Algarve: 2020-2022")
```

### Alentejo

```{r}
# Show tsibble
tourism_alentejo_until2022 %>%
  select(Month, Overnight_Stays) %>% 
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Monthly Number of Overnight Stays in Alentejo: 2000-2022</span>", format.args = list(big.mark = ","), align = "lcc") %>%
  column_spec(2, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

#### Seasonal Subseries Plot

```{r}
# Plot Seasonality Plot
tourism_alentejo_until2022 %>%
  gg_subseries(Overnight_Stays) +
  theme(strip.text.y = element_blank()) +
  ggtitle("Alentejo - Seasonality of Overnight Stays")
```

#### Time Series Variation

```{r}
# Difference from January 2001 to August 2000
diff_2000 <- tourism_alentejo_until2022 %>%
  mutate(Diff_to_August = difference(Overnight_Stays, 5)) %>%
  filter_index("2001 Jan")

# Difference from January 2020 to August 2019
diff_2019 <- tourism_alentejo_until2022 %>%
  mutate(Diff_to_August = difference(Overnight_Stays, 5)) %>%
  filter_index("2020 Jan")

# Show in one table
bind_rows(diff_2000, diff_2019) %>%
  select(Month, Overnight_Stays, Diff_to_August) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Alentejo's Seasonal Variation: 2000/2001 vs. 2019/2020</span>", digits = 2, format.args = list(big.mark = ","), align = "lcc") %>%
  column_spec(2:3, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  footnote("Diff_to_August = Diff between Jan and Aug of the previous year")

rm(diff_2000, diff_2019) # remove variables from R environment
```

#### Trend Calculation

```{r}
# Absolute and relative annual Differences of Overnight Stays
tourism_alentejo_until2022 %>%
  index_by(Year = year(Month)) %>%
  summarise(Sum_Overnight_Stays = sum(Overnight_Stays)) %>%
  mutate(Diff_abs = difference(Sum_Overnight_Stays, 1)) %>%
  mutate(Diff_rel = Diff_abs/(Sum_Overnight_Stays - Diff_abs)) %>%
  mutate(across(c("Sum_Overnight_Stays", "Diff_abs", "Diff_rel"), ~ format(.x, big.mark = ",", digits = 2))) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Abs. and rel. annual Differences of Overnight Stays in Alentejo</span>", align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

```{r}
# Calculate Mean of relative annual Differences of Overnight Stays: 2001-2009
mean_diff_2001 <- tourism_alentejo_until2022 %>%
  index_by(Year = year(Month)) %>%
  summarise(Sum_Overnight_Stays = sum(Overnight_Stays)) %>%
  mutate(Diff_abs = difference(Sum_Overnight_Stays, 1)) %>%
  mutate(Diff_rel = Diff_abs/(Sum_Overnight_Stays - Diff_abs)) %>%
  filter_index("2001", "2002","2003","2004","2005","2006","2007","2008", "2009") %>%
  select(Year, Diff_rel) %>%
  features(.var = Diff_rel,list(Mean_Diff_rel = mean)) %>%
  mutate(Year = "2000-2009")

# Calculate Mean of relative annual Differences of Overnight Stays: 2010-2019
mean_diff_2010 <- tourism_alentejo_until2022 %>%
  index_by(Year = year(Month)) %>%
  summarise(Sum_Overnight_Stays = sum(Overnight_Stays)) %>%
  mutate(Diff_abs = difference(Sum_Overnight_Stays, 1)) %>%
  mutate(Diff_rel = Diff_abs/(Sum_Overnight_Stays - Diff_abs)) %>%
  filter_index("2010", "2011", "2012","2013","2014","2015","2016","2017","2018", "2019") %>%
  select(Year, Diff_rel) %>%
  features(.var = Diff_rel,list(Mean_Diff_rel = mean)) %>%
  mutate(Year = "2010-2019")

# Show results in one table
bind_rows(mean_diff_2001, mean_diff_2010) %>%
  select(Year, Mean_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Mean of rel. annual Differences of Overnight Stays</span>", digits = 4, format.args = list(big.mark = ","), align = "lc") %>%
  column_spec(2, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

rm(mean_diff_2001, mean_diff_2010) # remove variables from R environment
```

```{r}
# Calculate Seasonal Difference of months in 2022 to 2021 and 2019
tourism_alentejo_until2022 %>%
  mutate(Year = year(Month)) %>%
  mutate(SeasDiff_to_2021_abs = difference(Overnight_Stays, 12)) %>%
  mutate(SeasDiff_to_2021_rel = SeasDiff_to_2021_abs/(Overnight_Stays-SeasDiff_to_2021_abs)) %>%
  mutate(SeasDiff_to_2019_abs = difference(Overnight_Stays, 36)) %>%
  mutate(SeasDiff_to_2019_rel = SeasDiff_to_2019_abs/(Overnight_Stays-SeasDiff_to_2019_abs)) %>%
  filter(Year == 2022) %>%
  select(Month, Overnight_Stays, SeasDiff_to_2021_abs, SeasDiff_to_2021_rel, SeasDiff_to_2019_abs, SeasDiff_to_2019_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Seasonal Differences of 2022 to 2021 & 2019</span>", digits = 4, format.args = list(big.mark = ","), align = "lccccc") %>%
  column_spec(2:6, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

#### STL Decomposition

```{r}
# Fit STL decomposition to data
dcmp_alentejo <- tourism_alentejo_until2022 %>%
  model(STL(Overnight_Stays))

# Plot components
dcmp_alentejo %>%
  components() %>%
  autoplot() +
  ggtitle("Alentejo - STL decomposition")

# Superimpose trend on top of time series
tourism_alentejo_until2022 %>%
  autoplot(Overnight_Stays, color = "gray") +
  autolayer(components(dcmp_alentejo), trend, color = "red") +
  ggtitle("Alentejo - Overnight Stays with superimposed Trend")
```

#### Detailed Analysis of Time Plots

```{r}
# Create Time plot for period 2000-2022
tourism_alentejo_until2022 %>%
  autoplot(Overnight_Stays) +
  ggtitle("Overnight Stays in Alentejo: 2000-2022")

# Create Time plot for period 2000-2019
tourism_alentejo_until2019 %>%
  autoplot(Overnight_Stays) +
  ggtitle("Overnight Stays in Alentejo: 2000-2019")

# Create Time plot for period 2020-2022
tourism_alentejo_until2022 %>%
  filter(year(Month) > 2019) %>%
  autoplot(Overnight_Stays) +
  ggtitle("Overnight Stays in Alentejo: 2020-2022")
```

# Fitting and Evaluating Models

## Madeira

### Recursive Window Cross-Validation

#### Time series Cross-Validation & Seasonal Strength Test

```{r}
# Cross-Validation with stretching Window to create Training sets
data_stretch_madeira <- tourism_madeira_until2022 %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Testing for Seasonal Strength
data_stretch_madeira %>%
  features(Overnight_Stays, unitroot_nsdiffs) %>%
  group_by(Region) %>%
  summarise(Mean_nsdiffs = (mean(nsdiffs))) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Seasonal Strength Test</span>", align = "lc") %>%
  column_spec(2, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

#### Fitting Models and one-step ahead Forecasts

```{r}
# Fit models
fit_madeira_stretch <- data_stretch_madeira %>%
  model(
    SNaive = SNAIVE(Overnight_Stays),
    Drift_STL = decomposition_model(STL(Overnight_Stays),RW(season_adjust ~ drift())),
    Naive = NAIVE(Overnight_Stays),
    TSLM = TSLM(Overnight_Stays ~ trend() + season()),
    ETS_auto = ETS(Overnight_Stays),
    HWA = ETS(Overnight_Stays ~ error("A") + trend("A") + season("A")),
    ARIMA_auto = ARIMA(Overnight_Stays),
    ARIMA_d1D1 = ARIMA(Overnight_Stays ~ pdq(d=1) + PDQ(D=1)),
    ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)),
    Prophet = fable.prophet::prophet(Overnight_Stays ~ season(period = 12)),
    SNaive_log = SNAIVE(log(Overnight_Stays)),
    Drift_STL_log = decomposition_model(STL(log(Overnight_Stays)),RW(season_adjust ~ drift())),
    Naive_log = NAIVE(log(Overnight_Stays)),
    TSLM_log = TSLM(log(Overnight_Stays) ~ trend() + season()),
    ETS_auto_log = ETS(log(Overnight_Stays)),
    HWA_log = ETS(log(Overnight_Stays) ~ error("A") + trend("A") + season("A")),
    ARIMA_auto_log = ARIMA(log(Overnight_Stays)),
    ARIMA_d1D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=1) + PDQ(D=1)),
    ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)),
    Prophet_log = fable.prophet::prophet(log(Overnight_Stays) ~ season(period = 12))
    )

# Perform a one-step ahead Forecast
fc_madeira_stretch <- fit_madeira_stretch %>% forecast(h=1)
```

#### Forecast Errors

```{r}
# Calculate forecast error per observation and model
error_fc_madeira_stretch <- merge(tourism_madeira_until2022, fc_madeira_stretch, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays-Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)

# Show table
error_fc_madeira_stretch %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Forecast Error per Observation and Model</span>", digits = 2, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

```{r}
# Show Point Forecasts in Plot: 2000-2022
error_fc_madeira_stretch %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_madeira_until2022, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2000-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2010-2022
tourism_madeira_from2010 <- tourism_madeira_until2022 %>%
  filter(year(Month) >= 2010)

error_fc_madeira_stretch %>%
  filter(year(Month) >= 2010) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_madeira_from2010, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2010-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2019-2022
tourism_madeira_from2019 <- tourism_madeira_until2022 %>%
  filter(year(Month) >= 2019)

error_fc_madeira_stretch %>%
  filter(year(Month) >= 2019) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_madeira_from2019, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2019-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2020-2022
tourism_madeira_from2020 <- tourism_madeira_until2022 %>%
  filter(year(Month) >= 2020)

error_fc_madeira_stretch %>%
  filter(year(Month) >= 2020) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_madeira_from2020, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2020-2022") +
  ylab("Overnight_Stays")
```

#### Change of RMSE: 2010-2019 vs. 2010-2022

**All Models**

Note: In the following, "All Models" means that all 20 models are shown. Each model appears twice: With the original & with the log-transformed variable.

```{r}
# Calculate RMSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_madeira_stretch, tourism_madeira_until2019) %>%
  arrange(RMSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSE_2019 = RMSE) %>%
  select(c(Rank_2019, Model, RMSE_2019))

# Calculate RMSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_madeira_stretch, tourism_madeira_until2022) %>%
  arrange(RMSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSE_2022 = RMSE) %>%
  select(c(Rank_2022, Model, RMSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSE", "Rank", "RMSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE: 2010-2019 vs. 2010-2022</span>", format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

**Each Model once**

Note: In the following, "Each Model once" means that each model appears only once: Either with the original or with the log-transformed variable (depending on the lowest RMSE for the 2010-2022 Forecasts).

```{r}
# Save best models according to the RMSE of Forecasts from 2010-2022
best_models_fc_madeira_stretch <- c("ARIMA_d0D1", "Drift_STL", "ARIMA_d1D1", "ARIMA_auto", "HWA_log", "ETS_auto_log", "Naive", "Prophet_log", "TSLM", "SNaive")

# Calculate RMSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_madeira_stretch, tourism_madeira_until2019) %>%
  filter(.model %in% best_models_fc_madeira_stretch) %>%
  arrange(RMSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSE_2019 = RMSE) %>%
  select(c(Rank_2019, Model, RMSE_2019))

# Calculate RMSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_madeira_stretch, tourism_madeira_until2022) %>%
  arrange(RMSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSE_2022 = RMSE) %>%
  select(c(Rank_2022, Model, RMSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSE", "Rank", "RMSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE: 2010-2019 vs. 2010-2022</span>", format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

#### RMSE Development  by including more Years in Time Series

```{r, warning = FALSE}
# Compute RMSE and RMSSE for 2010 and create tibble
tourism_until_i <- tourism_madeira_until2022 %>%
    filter(year(Month) <= 2010)

accuracy_madeira_stretch <- accuracy(fc_madeira_stretch, tourism_until_i) %>%
  select(c(.model, RMSE, RMSSE)) %>%
  mutate(Until_Year = 2010)

# Create tsibble of summarized RMSE and RMSSE, beginning in 2010 and including more years
for (i in 2011:2022){
  tourism_until_i <- tourism_madeira_until2022 %>%
    filter(year(Month) <= i)

  accuracy_next_year <- accuracy(fc_madeira_stretch, tourism_until_i) %>%
    select(c(.model, RMSE, RMSSE)) %>%
    mutate(Until_Year = i)

  accuracy_madeira_stretch <- rbind(accuracy_madeira_stretch, accuracy_next_year)
}

rm(accuracy_next_year, tourism_until_i) # remove variables from R environment

accuracy_madeira_stretch <- accuracy_madeira_stretch %>%
  rename(Model = .model) %>%
  select(c(Until_Year, Model, RMSE, RMSSE)) %>%
  as_tsibble(key = Model, index = Until_Year)

# Show table
accuracy_madeira_stretch %>%
  mutate(across(RMSE, ~ format(.x, big.mark = ","))) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Development of RMSE and RMSSE by including more Years in Time Series</span>", digits = 2, align = "cccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

**All Models**

```{r}
# Plot development of RMSE for period 2010-2022
accuracy_madeira_stretch %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2010-2019
accuracy_madeira_stretch %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2020-2022
accuracy_madeira_stretch %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

#  Change of RMSE by including 2020 in the time series
RMSE_until2019 <- accuracy_madeira_stretch %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2019) %>%
  rename(RMSE_2019 = RMSE)

RMSE_until2020 <- accuracy_madeira_stretch %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2020) %>%
  rename(RMSE_2020 = RMSE)

merge(RMSE_until2019, RMSE_until2020, by = "Model") %>%
  select(!c(Until_Year.x, Until_Year.y)) %>%
  mutate(Diff_abs = RMSE_2020 - RMSE_2019) %>%
  mutate(Diff_rel = Diff_abs/(RMSE_2020 - Diff_abs)) %>%
  arrange(Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE by including 2020 in Time Series</span>", format.args = list(big.mark = ","), digits = c(0,2,2,2,4), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

rm(RMSE_until2019, RMSE_until2020) # remove variables from R environment
```

**Each Model once**

```{r}
# Plot development of RMSE for period 2010-2022
accuracy_madeira_stretch %>%
  filter(Model %in% best_models_fc_madeira_stretch) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2010-2019
accuracy_madeira_stretch %>%
  filter(Until_Year <= 2019) %>%
  filter(Model %in% best_models_fc_madeira_stretch) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2020-2022
accuracy_madeira_stretch %>%
  filter(Until_Year > 2019) %>%
  filter(Model %in% best_models_fc_madeira_stretch) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  xlab("Until Year") +
  ylab("RMSE")

# Change of RMSE by including 2020 in the time series
RMSE_until2019 <- accuracy_madeira_stretch %>%
  filter(Model %in% best_models_fc_madeira_stretch) %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2019) %>%
  rename(RMSE_2019 = RMSE)

RMSE_until2020 <- accuracy_madeira_stretch %>%
  filter(Model %in% best_models_fc_madeira_stretch) %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2020) %>%
  rename(RMSE_2020 = RMSE)

merge(RMSE_until2019, RMSE_until2020, by = "Model") %>%
  select(!c(Until_Year.x, Until_Year.y)) %>%
  mutate(Diff_abs = RMSE_2020 - RMSE_2019) %>%
  mutate(Diff_rel = Diff_abs/(RMSE_2020 - Diff_abs)) %>%
  arrange(Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE by including 2020 in Time Series</span>", format.args = list(big.mark = ","), digits = c(0,2,2,2,4), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

rm(RMSE_until2019, RMSE_until2020) # remove variables from R environment
```

#### RMSE per Year

**All Models**

```{r}
# Calculate RMSE per year and save as tsibble
rmse_pyear_madeira_stretch <- error_fc_madeira_stretch %>%
  mutate(Year = year(Month)) %>%
  index_by(Year) %>%
  group_by(Model) %>%
  summarise(RMSE = (mean(Forecast_Error**2))**0.5)

# Create Plot for 2010-2022
rmse_pyear_madeira_stretch %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2010-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2))

# Create Plot for 2020-2022
rmse_pyear_madeira_stretch %>%
  filter(Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2))

# Show RMSE of 2020 with Difference to previous Year
rmse_pyear_madeira_stretch %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2020) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2020 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2021 with Difference to previous Year
rmse_pyear_madeira_stretch %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2021) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2021 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2022 with Difference to previous Year
rmse_pyear_madeira_stretch %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2022) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2022 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)
```

**Each Model once**

```{r}
# Create Plot for 2010-2022
rmse_pyear_madeira_stretch %>%
  filter(Model %in% best_models_fc_madeira_stretch) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2010-2022")

# Create Plot for 2020-2022
rmse_pyear_madeira_stretch %>%
  filter(Model %in% best_models_fc_madeira_stretch) %>%
  filter(Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2020-2022")

# Show RMSE of 2020 with Difference to previous Year
rmse_pyear_madeira_stretch %>%
  filter(Model %in% best_models_fc_madeira_stretch) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2020) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2020 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2021 with Difference to previous Year
rmse_pyear_madeira_stretch %>%
  filter(Model %in% best_models_fc_madeira_stretch) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2021) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2021 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2022 with Difference to previous Year
rmse_pyear_madeira_stretch %>%
  filter(Model %in% best_models_fc_madeira_stretch) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2022) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2022 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)


```

#### Change of RMSSE: 2010-2019 vs. 2010-2022

**All Models**

```{r}
# Calculate RMSSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_madeira_stretch, tourism_madeira_until2019) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSSE_2019 = RMSSE) %>%
  select(c(Rank_2019, Model, RMSSE_2019))

# Calculate RMSSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_madeira_stretch, tourism_madeira_until2022) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSSE_2022 = RMSSE) %>%
  select(c(Rank_2022, Model, RMSSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSSE", "Rank", "RMSSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSSE: 2010-2019 vs. 2010-2022</span>", digits = 4, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

**Each Model once**

```{r}
# Calculate RMSSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_madeira_stretch, tourism_madeira_until2019) %>%
  filter(.model %in% best_models_fc_madeira_stretch) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSSE_2019 = RMSSE) %>%
  select(c(Rank_2019, Model, RMSSE_2019))

# Calculate RMSSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_madeira_stretch, tourism_madeira_until2022) %>%
  filter(.model %in% best_models_fc_madeira_stretch) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSSE_2022 = RMSSE) %>%
  select(c(Rank_2022, Model, RMSSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSSE", "Rank", "RMSSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSSE: 2010-2019 vs. 2010-2022</span>", digits = 4, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

#### RMSSE Development by including more Years in Time Series

**All Models**

```{r}
# Plot development of RMSSE for period 2010-2022
accuracy_madeira_stretch %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2010-2019
accuracy_madeira_stretch %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2020-2022
accuracy_madeira_stretch %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")
```

**Each Model once**

```{r}
# Plot development of RMSSE for period 2010-2022
accuracy_madeira_stretch %>%
  filter(Model %in% best_models_fc_madeira_stretch) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2010-2019
accuracy_madeira_stretch %>%
  filter(Model %in% best_models_fc_madeira_stretch) %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2020-2022
accuracy_madeira_stretch %>%
  filter(Model %in% best_models_fc_madeira_stretch) %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  xlab("Until Year") +
  ylab("RMSSE")
```

### Rolling Window Cross-Validation

#### Time series Cross-Validation & Seasonal Strength Test

```{r}
# Cross-Validation with sliding Window to create Training sets
data_slide_madeira <- tourism_madeira_until2022 %>%
  slide_tsibble (.size = 120, .step = 1) %>%
  filter (.id != max(.id))

# Testing for Seasonal Strength
data_slide_madeira %>%
  features(Overnight_Stays, unitroot_nsdiffs) %>%
  group_by(Region) %>%
  summarise(Mean_nsdiffs = (mean(nsdiffs))) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Seasonal Strength Test</span>", align = "lc") %>%
  column_spec(2, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

#### Fitting Models and one-step ahead Forecasts

```{r}
# Fit models
fit_madeira_slide <- data_slide_madeira %>%
  model(
    SNaive = SNAIVE(Overnight_Stays),
    Drift_STL = decomposition_model(STL(Overnight_Stays),RW(season_adjust ~ drift())),
    Naive = NAIVE(Overnight_Stays),
    TSLM = TSLM(Overnight_Stays ~ trend() + season()),
    ETS_auto = ETS(Overnight_Stays),
    HWA = ETS(Overnight_Stays ~ error("A") + trend("A") + season("A")),
    ARIMA_auto = ARIMA(Overnight_Stays),
    ARIMA_d1D1 = ARIMA(Overnight_Stays ~ pdq(d=1) + PDQ(D=1)),
    ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)),
    Prophet = fable.prophet::prophet(Overnight_Stays ~ season(period = 12)),
    SNaive_log = SNAIVE(log(Overnight_Stays)),
    Drift_STL_log = decomposition_model(STL(log(Overnight_Stays)),RW(season_adjust ~ drift())),
    Naive_log = NAIVE(log(Overnight_Stays)),
    TSLM_log = TSLM(log(Overnight_Stays) ~ trend() + season()),
    ETS_auto_log = ETS(log(Overnight_Stays)),
    HWA_log = ETS(log(Overnight_Stays) ~ error("A") + trend("A") + season("A")),
    ARIMA_auto_log = ARIMA(log(Overnight_Stays)),
    ARIMA_d1D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=1) + PDQ(D=1)),
    ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)),
    Prophet_log = fable.prophet::prophet(log(Overnight_Stays) ~ season(period = 12))
    )

# Perform a one-step ahead Forecast
fc_madeira_slide <- fit_madeira_slide %>% forecast(h=1)
```

#### Forecast Errors

```{r}
# Calculate forecast error per observation and model
error_fc_madeira_slide <- merge(tourism_madeira_until2022, fc_madeira_slide, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays-Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)

# Show table
error_fc_madeira_slide %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Forecast Error per Observation and Model</span>", digits = 2, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

```{r}
# Show Point Forecasts in Plot: 2000-2022
error_fc_madeira_slide %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_madeira_until2022, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2000-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2010-2022
error_fc_madeira_slide %>%
  filter(year(Month) >= 2010) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_madeira_from2010, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2010-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2019-2022
error_fc_madeira_slide %>%
  filter(year(Month) >= 2019) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_madeira_from2019, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2019-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2020-2022
error_fc_madeira_slide %>%
  filter(year(Month) >= 2020) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_madeira_from2020, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2020-2022") +
  ylab("Overnight_Stays")
```

#### Change of RMSE: 2010-2019 vs. 2010-2022

**All Models**

```{r}
# Calculate RMSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_madeira_slide, tourism_madeira_until2019) %>%
  arrange(RMSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSE_2019 = RMSE) %>%
  select(c(Rank_2019, Model, RMSE_2019))

# Calculate RMSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_madeira_slide, tourism_madeira_until2022) %>%
  arrange(RMSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSE_2022 = RMSE) %>%
  select(c(Rank_2022, Model, RMSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSE", "Rank", "RMSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE: 2010-2019 vs. 2010-2022</span>", format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

**Each Model once**

```{r}
# Save best models according to the RMSE of Forecasts from 2010-2022
best_models_fc_madeira_slide <- c("ARIMA_d0D1", "Drift_STL", "ARIMA_d1D1", "ARIMA_auto", "HWA", "ETS_auto", "Naive", "Prophet", "TSLM", "SNaive")

# Calculate RMSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_madeira_slide, tourism_madeira_until2019) %>%
  filter(.model %in% best_models_fc_madeira_slide) %>%
  arrange(RMSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSE_2019 = RMSE) %>%
  select(c(Rank_2019, Model, RMSE_2019))

# Calculate RMSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_madeira_slide, tourism_madeira_until2022) %>%
  filter(.model %in% best_models_fc_madeira_slide) %>%
  arrange(RMSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSE_2022 = RMSE) %>%
  select(c(Rank_2022, Model, RMSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSE", "Rank", "RMSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE: 2010-2019 vs. 2010-2022</span>", format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

#### RMSE Development  by including more Years in Time Series

```{r, warning = FALSE}
# Compute RMSE and RMSSE for 2010 and create tibble
tourism_until_i <- tourism_madeira_until2022 %>%
    filter(year(Month) <= 2010)

accuracy_madeira_slide <- accuracy(fc_madeira_slide, tourism_until_i) %>%
  select(c(.model, RMSE, RMSSE)) %>%
  mutate(Until_Year = 2010)

# Create tsibble of summarized RMSE and RMSSE, beginning in 2010 and including more years
for (i in 2011:2022){
  tourism_until_i <- tourism_madeira_until2022 %>%
    filter(year(Month) <= i)

  accuracy_next_year <- accuracy(fc_madeira_slide, tourism_until_i) %>%
    select(c(.model, RMSE, RMSSE)) %>%
    mutate(Until_Year = i)

  accuracy_madeira_slide <- rbind(accuracy_madeira_slide, accuracy_next_year)
}

rm(accuracy_next_year, tourism_until_i) # remove variables from R environment

accuracy_madeira_slide <- accuracy_madeira_slide %>%
  rename(Model = .model) %>%
  select(c(Until_Year, Model, RMSE, RMSSE)) %>%
  as_tsibble(key = Model, index = Until_Year)

# Show table
accuracy_madeira_slide %>%
  mutate(across(RMSE, ~ format(.x, big.mark = ","))) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Development of RMSE and RMSSE by including more Years in Time Series</span>", digits = 2, align = "cccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

**All Models**

```{r}
# Plot development of RMSE for period 2010-2022
accuracy_madeira_slide %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2010-2019
accuracy_madeira_slide %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2020-2022
accuracy_madeira_slide %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Change of RMSE by including 2020 in the time series
RMSE_until2019 <- accuracy_madeira_slide %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2019) %>%
  rename(RMSE_2019 = RMSE)

RMSE_until2020 <- accuracy_madeira_slide %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2020) %>%
  rename(RMSE_2020 = RMSE)

merge(RMSE_until2019, RMSE_until2020, by = "Model") %>%
  select(!c(Until_Year.x, Until_Year.y)) %>%
  mutate(Diff_abs = RMSE_2020 - RMSE_2019) %>%
  mutate(Diff_rel = Diff_abs/(RMSE_2020 - Diff_abs)) %>%
  arrange(Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE by including 2020 in Time Series</span>", format.args = list(big.mark = ","), digits = c(0,2,2,2,4), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

rm(RMSE_until2019, RMSE_until2020) # remove variables from R environment
```

**Each Model once**

```{r}
# Plot development of RMSE for period 2010-2022
accuracy_madeira_slide %>%
  filter(Model %in% best_models_fc_madeira_slide) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2010-2019
accuracy_madeira_slide %>%
  filter(Model %in% best_models_fc_madeira_slide) %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2020-2022
accuracy_madeira_slide %>%
  filter(Model %in% best_models_fc_madeira_slide) %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  xlab("Until Year") +
  ylab("RMSE")

# Change of RMSE by including 2020 in the time series
RMSE_until2019 <- accuracy_madeira_slide %>%
  filter(Model %in% best_models_fc_madeira_slide) %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2019) %>%
  rename(RMSE_2019 = RMSE)

RMSE_until2020 <- accuracy_madeira_slide %>%
  filter(Model %in% best_models_fc_madeira_slide) %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2020) %>%
  rename(RMSE_2020 = RMSE)

merge(RMSE_until2019, RMSE_until2020, by = "Model") %>%
  select(!c(Until_Year.x, Until_Year.y)) %>%
  mutate(Diff_abs = RMSE_2020 - RMSE_2019) %>%
  mutate(Diff_rel = Diff_abs/(RMSE_2020 - Diff_abs)) %>%
  arrange(Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE by including 2020 in Time Series</span>", format.args = list(big.mark = ","), digits = c(0,2,2,2,4), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

rm(RMSE_until2019, RMSE_until2020) # remove variables from R environment
```

#### RMSE per Year

**All Models**

```{r}
# Calculate RMSE per year and save as tsibble
rmse_pyear_madeira_slide <- error_fc_madeira_slide %>%
  mutate(Year = year(Month)) %>%
  index_by(Year) %>%
  group_by(Model) %>%
  summarise(RMSE = (mean(Forecast_Error**2))**0.5)

# Create Plot for 2010-2022
rmse_pyear_madeira_slide %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2010-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2))

# Create Plot for 2020-2022
rmse_pyear_madeira_slide %>%
  filter(Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2))

# Show RMSE of 2020 with Difference to previous Year
rmse_pyear_madeira_slide %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2020) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2020 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2021 with Difference to previous Year
rmse_pyear_madeira_slide %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2021) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2021 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2021 with Difference to previous Year
rmse_pyear_madeira_slide %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2022) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2022 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)
```

**Each Model once**

```{r}
# Create Plot for 2010-2022
rmse_pyear_madeira_slide %>%
  filter(Model %in% best_models_fc_madeira_slide) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2010-2022")

# Create Plot for 2020-2022
rmse_pyear_madeira_slide %>%
  filter(Model %in% best_models_fc_madeira_slide) %>%
  filter(Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2020-2022")

# Show RMSE of 2020 with Difference to previous Year
rmse_pyear_madeira_slide %>%
  filter(Model %in% best_models_fc_madeira_slide) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2020) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2020 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2021 with Difference to previous Year
rmse_pyear_madeira_slide %>%
  filter(Model %in% best_models_fc_madeira_slide) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2021) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2021 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2022 with Difference to previous Year
rmse_pyear_madeira_slide %>%
  filter(Model %in% best_models_fc_madeira_slide) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2022) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2022 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)
```

#### Change of RMSSE: 2010-2019 vs. 2010-2022

**All Models**

```{r}
# Calculate RMSSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_madeira_slide, tourism_madeira_until2019) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSSE_2019 = RMSSE) %>%
  select(c(Rank_2019, Model, RMSSE_2019))

# Calculate RMSSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_madeira_slide, tourism_madeira_until2022) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSSE_2022 = RMSSE) %>%
  select(c(Rank_2022, Model, RMSSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSSE", "Rank", "RMSSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSSE: 2010-2019 vs. 2010-2022</span>", digits = 4, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

**Each Model once**

```{r}
# Calculate RMSSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_madeira_slide, tourism_madeira_until2019) %>%
  filter(.model %in% best_models_fc_madeira_slide) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSSE_2019 = RMSSE) %>%
  select(c(Rank_2019, Model, RMSSE_2019))

# Calculate RMSSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_madeira_slide, tourism_madeira_until2022) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSSE_2022 = RMSSE) %>%
  select(c(Rank_2022, Model, RMSSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSSE", "Rank", "RMSSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSSE: 2010-2019 vs. 2010-2022</span>", digits = 4, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

#### RMSSE Development by including more Years in Time Series

**All Models**

```{r}
# Plot development of RMSSE for period 2010-2022
accuracy_madeira_slide %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2010-2019
accuracy_madeira_slide %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2020-2022
accuracy_madeira_slide %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")
```

**Each Model once**

```{r}
# Plot development of RMSSE for period 2010-2022
accuracy_madeira_slide %>%
  filter(Model %in% best_models_fc_madeira_slide) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2010-2019
accuracy_madeira_slide %>%
  filter(Model %in% best_models_fc_madeira_slide) %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2020-2022
accuracy_madeira_slide %>%
  filter(Model %in% best_models_fc_madeira_slide) %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  xlab("Until Year") +
  ylab("RMSSE")
```

## Algarve

### Recursive Window Cross-Validation

#### Time series Cross-Validation & Seasonal Strength Test

```{r}
# Cross-Validation to create Training sets
data_stretch_algarve <- tourism_algarve_until2022 %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Testing for Seasonal Strength
data_stretch_algarve %>%
  features(Overnight_Stays, unitroot_nsdiffs) %>%
  group_by(Region) %>%
  summarise(Mean_nsdiffs = (mean(nsdiffs))) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Seasonal Strength Test</span>", align = "lc") %>%
  column_spec(2, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

#### Fitting Models and one-step ahead Forecasts

```{r}
# Fit models
fit_algarve_stretch <- data_stretch_algarve %>%
  model(
    SNaive = SNAIVE(Overnight_Stays),
    Drift_STL = decomposition_model(STL(Overnight_Stays),RW(season_adjust ~ drift())),
    Naive = NAIVE(Overnight_Stays),
    TSLM = TSLM(Overnight_Stays ~ trend() + season()),
    ETS_auto = ETS(Overnight_Stays),
    HWA = ETS(Overnight_Stays ~ error("A") + trend("A") + season("A")),
    ARIMA_auto = ARIMA(Overnight_Stays),
		ARIMA_d1D1 = ARIMA(Overnight_Stays ~ pdq(d=1) + PDQ(D=1)),
		ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)),
		Prophet = fable.prophet::prophet(Overnight_Stays ~ season(period = 12)),
		SNaive_log = SNAIVE(log(Overnight_Stays)),
    Drift_STL_log = decomposition_model(STL(log(Overnight_Stays)),RW(season_adjust ~ drift())),
    Naive_log = NAIVE(log(Overnight_Stays)),
    TSLM_log = TSLM(log(Overnight_Stays) ~ trend() + season()),
    ETS_auto_log = ETS(log(Overnight_Stays)),
		HWA_log = ETS(log(Overnight_Stays) ~ error("A") + trend("A") + season("A")),
    ARIMA_auto_log = ARIMA(log(Overnight_Stays)),
    ARIMA_d1D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=1) + PDQ(D=1)),
    ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)),
    Prophet_log = fable.prophet::prophet(log(Overnight_Stays) ~ season(period = 12))
    )

# Perform a one-step ahead Forecast
fc_algarve_stretch <- fit_algarve_stretch %>% forecast(h=1)
```

#### Forecast Errors

```{r}
# Calculate forecast error per observation and model
error_fc_algarve_stretch <- merge(tourism_algarve_until2022, fc_algarve_stretch, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays-Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)

# Show table
error_fc_algarve_stretch %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Forecast Error per Observation and Model</span>", digits = 2, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

```{r}
# Show Point Forecasts in Plot: 2000-2022
error_fc_algarve_stretch %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_algarve_until2022, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2000-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2010-2022
tourism_algarve_from2010 <- tourism_algarve_until2022 %>%
  filter(year(Month) >= 2010)

error_fc_algarve_stretch %>%
  filter(year(Month) >= 2010) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_algarve_from2010, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2010-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2019-2022
tourism_algarve_from2019 <- tourism_algarve_until2022 %>%
  filter(year(Month) >= 2019)

error_fc_algarve_stretch %>%
  filter(year(Month) >= 2019) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_algarve_from2019, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2019-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2020-2022
tourism_algarve_from2020 <- tourism_algarve_until2022 %>%
  filter(year(Month) >= 2020)

error_fc_algarve_stretch %>%
  filter(year(Month) >= 2020) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_algarve_from2020, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2020-2022") +
  ylab("Overnight_Stays")
```

#### Change of RMSE: 2010-2019 vs. 2010-2022

**All Models**

Note: In the following, "All Models" means that all 20 models are shown. Each model appears twice: With the original & with the log-transformed variable.

```{r}
# Calculate RMSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_algarve_stretch, tourism_algarve_until2019) %>%
  arrange(RMSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSE_2019 = RMSE) %>%
  select(c(Rank_2019, Model, RMSE_2019))

# Calculate RMSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_algarve_stretch, tourism_algarve_until2022) %>%
  arrange(RMSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSE_2022 = RMSE) %>%
  select(c(Rank_2022, Model, RMSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSE", "Rank", "RMSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE: 2010-2019 vs. 2010-2022</span>", format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

**Each Model once**

Note: In the following, "Each Model once" means that each model appears only once: Either with the original or with the log-transformed variable (depending on the lowest RMSE for the 2010-2022 Forecasts).

```{r}
# Save best models according to the RMSE of Forecasts from 2010-2022
best_models_fc_algarve_stretch <- c("ARIMA_d0D1", "Drift_STL", "ARIMA_d1D1", "ARIMA_auto", "HWA_log", "ETS_auto_log", "Naive", "Prophet_log", "TSLM", "SNaive")

# Calculate RMSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_algarve_stretch, tourism_algarve_until2019) %>%
  filter(.model %in% best_models_fc_algarve_stretch) %>%
  arrange(RMSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSE_2019 = RMSE) %>%
  select(c(Rank_2019, Model, RMSE_2019))

# Calculate RMSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_algarve_stretch, tourism_algarve_until2022) %>%
  filter(.model %in% best_models_fc_algarve_stretch) %>%
  arrange(RMSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSE_2022 = RMSE) %>%
  select(c(Rank_2022, Model, RMSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSE", "Rank", "RMSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE: 2010-2019 vs. 2010-2022</span>", format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

#### RMSE Development  by including more Years in Time Series

```{r, warning = FALSE}
# Compute RMSE and RMSSE for 2010 and create tibble
tourism_until_i <- tourism_algarve_until2022 %>%
    filter(year(Month) <= 2010)

accuracy_algarve_stretch <- accuracy(fc_algarve_stretch, tourism_until_i) %>%
  select(c(.model, RMSE, RMSSE)) %>%
  mutate(Until_Year = 2010)

# Create tsibble of summarized RMSE and RMSSE, beginning in 2010 and including more years
for (i in 2011:2022){
  tourism_until_i <- tourism_algarve_until2022 %>%
    filter(year(Month) <= i)

  accuracy_next_year <- accuracy(fc_algarve_stretch, tourism_until_i) %>%
    select(c(.model, RMSE, RMSSE)) %>%
    mutate(Until_Year = i)

  accuracy_algarve_stretch <- rbind(accuracy_algarve_stretch, accuracy_next_year)
}

rm(accuracy_next_year, tourism_until_i) # remove variables from R environment

accuracy_algarve_stretch <- accuracy_algarve_stretch %>%
  rename(Model = .model) %>%
  select(c(Until_Year, Model, RMSE, RMSSE)) %>%
  as_tsibble(key = Model, index = Until_Year)

# Show table
accuracy_algarve_stretch %>%
  mutate(across(RMSE, ~ format(.x, big.mark = ","))) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Development of RMSE and RMSSE by including more Years in Time Series</span>", digits = 2, align = "cccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

**All Models**

```{r}
# Plot development of RMSE for period 2010-2022
accuracy_algarve_stretch %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2010-2019
accuracy_algarve_stretch %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2020-2022
accuracy_algarve_stretch %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Change of RMSE by including 2020 in the time series
RMSE_until2019 <- accuracy_algarve_stretch %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2019) %>%
  rename(RMSE_2019 = RMSE)

RMSE_until2020 <- accuracy_algarve_stretch %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2020) %>%
  rename(RMSE_2020 = RMSE)

merge(RMSE_until2019, RMSE_until2020, by = "Model") %>%
  select(!c(Until_Year.x, Until_Year.y)) %>%
  mutate(Diff_abs = RMSE_2020 - RMSE_2019) %>%
  mutate(Diff_rel = Diff_abs/(RMSE_2020 - Diff_abs)) %>%
  arrange(Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE by including 2020 in Time Series</span>", format.args = list(big.mark = ","), digits = c(0,2,2,2,4), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

rm(RMSE_until2019, RMSE_until2020) # remove variables from R environment
```

**Each Model once**

```{r}
# Plot development of RMSE for period 2010-2022
accuracy_algarve_stretch %>%
  filter(Model %in% best_models_fc_algarve_stretch) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2010-2019
accuracy_algarve_stretch %>%
  filter(Model %in% best_models_fc_algarve_stretch) %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2020-2022
accuracy_algarve_stretch %>%
  filter(Model %in% best_models_fc_algarve_stretch) %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  xlab("Until Year") +
  ylab("RMSE")

# Change of RMSE by including 2020 in the time series
RMSE_until2019 <- accuracy_algarve_stretch %>%
  filter(Model %in% best_models_fc_algarve_stretch) %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2019) %>%
  rename(RMSE_2019 = RMSE)

RMSE_until2020 <- accuracy_algarve_stretch %>%
  filter(Model %in% best_models_fc_algarve_stretch) %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2020) %>%
  rename(RMSE_2020 = RMSE)

merge(RMSE_until2019, RMSE_until2020, by = "Model") %>%
  select(!c(Until_Year.x, Until_Year.y)) %>%
  mutate(Diff_abs = RMSE_2020 - RMSE_2019) %>%
  mutate(Diff_rel = Diff_abs/(RMSE_2020 - Diff_abs)) %>%
  arrange(Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE by including 2020 in Time Series</span>", format.args = list(big.mark = ","), digits = c(0,2,2,2,4), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

rm(RMSE_until2019, RMSE_until2020) # remove variables from R environment
```

#### RMSE per Year

**All Models**

```{r}
# Calculate RMSE per year and save as tsibble
rmse_pyear_algarve_stretch <- error_fc_algarve_stretch %>%
  mutate(Year = year(Month)) %>%
  index_by(Year) %>%
  group_by(Model) %>%
  summarise(RMSE = (mean(Forecast_Error**2))**0.5)

# Create Plot for 2010-2022
rmse_pyear_algarve_stretch %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2010-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2))

# Create Plot for 2020-2022
rmse_pyear_algarve_stretch %>%
  filter(Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2))

# Show RMSE of 2020 with Difference to previous Year
rmse_pyear_algarve_stretch %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2020) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2020 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2021 with Difference to previous Year
rmse_pyear_algarve_stretch %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2021) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2021 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2022 with Difference to previous Year
rmse_pyear_algarve_stretch %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2022) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2022 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)
```

**Each Model once**

```{r}
# Create Plot for 2010-2022
rmse_pyear_algarve_stretch %>%
  filter(Model %in% best_models_fc_algarve_stretch) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2010-2022")

# Create Plot for 2020-2022
rmse_pyear_algarve_stretch %>%
  filter(Model %in% best_models_fc_algarve_stretch) %>%
  filter(Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2020-2022")

# Show RMSE of specific years with Difference to year before
# Show RMSE of 2020
rmse_pyear_algarve_stretch %>%
  filter(Model %in% best_models_fc_algarve_stretch) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2020) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2020 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2021
rmse_pyear_algarve_stretch %>%
  filter(Model %in% best_models_fc_algarve_stretch) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2021) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2021 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2022
rmse_pyear_algarve_stretch %>%
  filter(Model %in% best_models_fc_algarve_stretch) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2022) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2022 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)
```

#### Change of RMSSE: 2010-2019 vs. 2010-2022

**All Models**

```{r}
# Calculate RMSSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_algarve_stretch, tourism_algarve_until2019) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSSE_2019 = RMSSE) %>%
  select(c(Rank_2019, Model, RMSSE_2019))

# Calculate RMSSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_algarve_stretch, tourism_algarve_until2022) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSSE_2022 = RMSSE) %>%
  select(c(Rank_2022, Model, RMSSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSSE", "Rank", "RMSSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSSE: 2010-2019 vs. 2010-2022</span>", digits = 4, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

**Each Model once**

```{r}
# Calculate RMSSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_algarve_stretch, tourism_algarve_until2019) %>%
  filter(.model %in% best_models_fc_algarve_stretch) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSSE_2019 = RMSSE) %>%
  select(c(Rank_2019, Model, RMSSE_2019))

# Calculate RMSSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_algarve_stretch, tourism_algarve_until2022) %>%
  filter(.model %in% best_models_fc_algarve_stretch) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSSE_2022 = RMSSE) %>%
  select(c(Rank_2022, Model, RMSSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSSE", "Rank", "RMSSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSSE: 2010-2019 vs. 2010-2022</span>", digits = 4, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

#### RMSSE Development by including more Years in Time Series

**All Models**

```{r}
# Plot development of RMSSE for period 2010-2022
accuracy_algarve_stretch %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2010-2019
accuracy_algarve_stretch %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2020-2022
accuracy_algarve_stretch %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")
```

**Each Model once**

```{r}
# Plot development of RMSSE for period 2010-2022
accuracy_algarve_stretch %>%
  filter(Model %in% best_models_fc_algarve_stretch) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2010-2019
accuracy_algarve_stretch %>%
  filter(Model %in% best_models_fc_algarve_stretch) %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2020-2022
accuracy_algarve_stretch %>%
  filter(Model %in% best_models_fc_algarve_stretch) %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  xlab("Until Year") +
  ylab("RMSSE")
```

### Rolling Window Cross-Validation

#### Time series Cross-Validation & Seasonal Strength Test

```{r}
# Cross-Validation with sliding Window to create Training sets
data_slide_algarve <- tourism_algarve_until2022 %>%
  slide_tsibble (.size = 120, .step = 1) %>%
  filter (.id != max(.id))

# Testing for Seasonal Strength
data_slide_algarve %>%
  features(Overnight_Stays, unitroot_nsdiffs) %>%
  group_by(Region) %>%
  summarise(Mean_nsdiffs = (mean(nsdiffs))) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Seasonal Strength Test</span>", align = "lc") %>%
  column_spec(2, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

#### Fitting Models and one-step ahead Forecasts

```{r}
# Fit models
fit_algarve_slide <- data_slide_algarve %>%
  model(
    SNaive = SNAIVE(Overnight_Stays),
    Drift_STL = decomposition_model(STL(Overnight_Stays),RW(season_adjust ~ drift())),
    Naive = NAIVE(Overnight_Stays),
    TSLM = TSLM(Overnight_Stays ~ trend() + season()),
    ETS_auto = ETS(Overnight_Stays),
    HWA = ETS(Overnight_Stays ~ error("A") + trend("A") + season("A")),
    ARIMA_auto = ARIMA(Overnight_Stays),
    ARIMA_d1D1 = ARIMA(Overnight_Stays ~ pdq(d=1) + PDQ(D=1)),
    ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)),
    Prophet = fable.prophet::prophet(Overnight_Stays ~ season(period = 12)),
    SNaive_log = SNAIVE(log(Overnight_Stays)),
    Drift_STL_log = decomposition_model(STL(log(Overnight_Stays)),RW(season_adjust ~ drift())),
    Naive_log = NAIVE(log(Overnight_Stays)),
    TSLM_log = TSLM(log(Overnight_Stays) ~ trend() + season()),
    ETS_auto_log = ETS(log(Overnight_Stays)),
    HWA_log = ETS(log(Overnight_Stays) ~ error("A") + trend("A") + season("A")),
    ARIMA_auto_log = ARIMA(log(Overnight_Stays)),
    ARIMA_d1D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=1) + PDQ(D=1)),
    ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)),
    Prophet_log = fable.prophet::prophet(log(Overnight_Stays) ~ season(period = 12))
    )

# Perform a one-step ahead Forecast
fc_algarve_slide <- fit_algarve_slide %>% forecast(h=1)
```

#### Forecast Errors

```{r}
# Calculate forecast error per observation and model
error_fc_algarve_slide <- merge(tourism_algarve_until2022, fc_algarve_slide, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays-Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)

# Show table
error_fc_algarve_slide %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Forecast Error per Observation and Model</span>", digits = 2, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

```{r}
# Show Point Forecasts in Plot: 2000-2022
error_fc_algarve_slide %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_algarve_until2022, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2000-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2010-2022
error_fc_algarve_slide %>%
  filter(year(Month) >= 2010) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_algarve_from2010, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2010-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2019-2022
error_fc_algarve_slide %>%
  filter(year(Month) >= 2019) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_algarve_from2019, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2019-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2020-2022
error_fc_algarve_slide %>%
  filter(year(Month) >= 2020) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_algarve_from2020, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2020-2022") +
  ylab("Overnight_Stays")
```

#### Change of RMSE: 2010-2019 vs. 2010-2022

**All Models**

```{r}
# Calculate RMSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_algarve_slide, tourism_algarve_until2019) %>%
  arrange(RMSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSE_2019 = RMSE) %>%
  select(c(Rank_2019, Model, RMSE_2019))

# Calculate RMSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_algarve_slide, tourism_algarve_until2022) %>%
  arrange(RMSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSE_2022 = RMSE) %>%
  select(c(Rank_2022, Model, RMSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSE", "Rank", "RMSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE: 2010-2019 vs. 2010-2022</span>", format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

**Each Model once**

```{r}
# Save best models according to the RMSE of Forecasts from 2010-2022
best_models_fc_algarve_slide <- c("ARIMA_d0D1", "Drift_STL", "ARIMA_d1D1", "ARIMA_auto", "HWA", "ETS_auto", "Naive", "Prophet", "TSLM", "SNaive")

# Calculate RMSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_algarve_slide, tourism_algarve_until2019) %>%
  filter(.model %in% best_models_fc_algarve_slide) %>%
  arrange(RMSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSE_2019 = RMSE) %>%
  select(c(Rank_2019, Model, RMSE_2019))

# Calculate RMSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_algarve_slide, tourism_algarve_until2022) %>%
  filter(.model %in% best_models_fc_algarve_slide) %>%
  arrange(RMSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSE_2022 = RMSE) %>%
  select(c(Rank_2022, Model, RMSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSE", "Rank", "RMSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE: 2010-2019 vs. 2010-2022</span>", format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

#### RMSE Development  by including more Years in Time Series

```{r, warning = FALSE}
# Compute RMSE and RMSSE for 2010 and create tibble
tourism_until_i <- tourism_algarve_until2022 %>%
    filter(year(Month) <= 2010)

accuracy_algarve_slide <- accuracy(fc_algarve_slide, tourism_until_i) %>%
  select(c(.model, RMSE, RMSSE)) %>%
  mutate(Until_Year = 2010)

# Create tsibble of summarized RMSE and RMSSE, beginning in 2010 and including more years
for (i in 2011:2022){
  tourism_until_i <- tourism_algarve_until2022 %>%
    filter(year(Month) <= i)

  accuracy_next_year <- accuracy(fc_algarve_slide, tourism_until_i) %>%
    select(c(.model, RMSE, RMSSE)) %>%
    mutate(Until_Year = i)

  accuracy_algarve_slide <- rbind(accuracy_algarve_slide, accuracy_next_year)
}

rm(accuracy_next_year, tourism_until_i) # remove variables from R environment

accuracy_algarve_slide <- accuracy_algarve_slide %>%
  rename(Model = .model) %>%
  select(c(Until_Year, Model, RMSE, RMSSE)) %>%
  as_tsibble(key = Model, index = Until_Year)

# Show table
accuracy_algarve_slide %>%
  mutate(across(RMSE, ~ format(.x, big.mark = ","))) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Development of RMSE and RMSSE by including more Years in Time Series</span>", digits = 2, align = "cccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

**All Models**

```{r}
# Plot development of RMSE for period 2010-2022
accuracy_algarve_slide %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2010-2019
accuracy_algarve_slide %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2020-2022
accuracy_algarve_slide %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Change of RMSE by including 2020 in the time series
RMSE_until2019 <- accuracy_algarve_slide %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2019) %>%
  rename(RMSE_2019 = RMSE)

RMSE_until2020 <- accuracy_algarve_slide %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2020) %>%
  rename(RMSE_2020 = RMSE)

merge(RMSE_until2019, RMSE_until2020, by = "Model") %>%
  select(!c(Until_Year.x, Until_Year.y)) %>%
  mutate(Diff_abs = RMSE_2020 - RMSE_2019) %>%
  mutate(Diff_rel = Diff_abs/(RMSE_2020 - Diff_abs)) %>%
  arrange(Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE by including 2020 in Time Series</span>", format.args = list(big.mark = ","), digits = c(0,2,2,2,4), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

# DELETE!
accuracy_algarve_slide %>%
  mutate(across(RMSE, ~ format(.x, big.mark = ","))) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Development of RMSE and RMSSE by including more Years in Time Series</span>", digits = 2, align = "cccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")


rm(RMSE_until2019, RMSE_until2020) # remove variables from R environment
```

**Each Model once**

```{r}
# Plot development of RMSE for period 2010-2022
accuracy_algarve_slide %>%
  filter(Model %in% best_models_fc_algarve_slide) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2010-2019
accuracy_algarve_slide %>%
  filter(Model %in% best_models_fc_algarve_slide) %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2020-2022
accuracy_algarve_slide %>%
  filter(Model %in% best_models_fc_algarve_slide) %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  xlab("Until Year") +
  ylab("RMSE")

# Change of RMSE by including 2020 in the time series
RMSE_until2019 <- accuracy_algarve_slide %>%
  filter(Model %in% best_models_fc_algarve_slide) %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2019) %>%
  rename(RMSE_2019 = RMSE)

RMSE_until2020 <- accuracy_algarve_slide %>%
  filter(Model %in% best_models_fc_algarve_slide) %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2020) %>%
  rename(RMSE_2020 = RMSE)

merge(RMSE_until2019, RMSE_until2020, by = "Model") %>%
  select(!c(Until_Year.x, Until_Year.y)) %>%
  mutate(Diff_abs = RMSE_2020 - RMSE_2019) %>%
  mutate(Diff_rel = Diff_abs/(RMSE_2020 - Diff_abs)) %>%
  arrange(Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE by including 2020 in Time Series</span>", format.args = list(big.mark = ","), digits = c(0,2,2,2,4), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

rm(RMSE_until2019, RMSE_until2020) # remove variables from R environment
```

#### RMSE per Year

**All Models**

```{r}
# Calculate RMSE per year and save as tsibble
rmse_pyear_algarve_slide <- error_fc_algarve_slide %>%
  mutate(Year = year(Month)) %>%
  index_by(Year) %>%
  group_by(Model) %>%
  summarise(RMSE = (mean(Forecast_Error**2))**0.5)

# Create Plot for 2010-2022
rmse_pyear_algarve_slide %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2010-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2))

# Create Plot for 2020-2022
rmse_pyear_algarve_slide %>%
  filter(Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2))

# Show RMSE of 2020 with Difference to previous Year
rmse_pyear_algarve_slide %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2020) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2020 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2021 with Difference to previous Year
rmse_pyear_algarve_slide %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2021) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2021 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2022 with Difference to previous Year
rmse_pyear_algarve_slide %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2022) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2022 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)
```

**Each Model once**

```{r}
# Create Plot for 2010-2022
rmse_pyear_algarve_slide %>%
  filter(Model %in% best_models_fc_algarve_slide) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2010-2022")

# Create Plot for 2020-2022
rmse_pyear_algarve_slide %>%
  filter(Model %in% best_models_fc_algarve_slide) %>%
  filter(Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2020-2022")

# Show RMSE of 2020 with Difference to previous Year
rmse_pyear_algarve_slide %>%
  filter(Model %in% best_models_fc_algarve_slide) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2020) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2020 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2021 with Difference to previous Year
rmse_pyear_algarve_slide %>%
  filter(Model %in% best_models_fc_algarve_slide) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2021) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2021 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2022 with Difference to previous Year
rmse_pyear_algarve_slide %>%
  filter(Model %in% best_models_fc_algarve_slide) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2022) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2022 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)
```

#### Change of RMSSE: 2010-2019 vs. 2010-2022

**All Models**

```{r}
# Calculate RMSSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_algarve_slide, tourism_algarve_until2019) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSSE_2019 = RMSSE) %>%
  select(c(Rank_2019, Model, RMSSE_2019))

# Calculate RMSSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_algarve_slide, tourism_algarve_until2022) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSSE_2022 = RMSSE) %>%
  select(c(Rank_2022, Model, RMSSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSSE", "Rank", "RMSSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSSE: 2010-2019 vs. 2010-2022</span>", digits = 4, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

**Each Model once**

```{r}
# Calculate RMSSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_algarve_slide, tourism_algarve_until2019) %>%
  filter(.model %in% best_models_fc_algarve_slide) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSSE_2019 = RMSSE) %>%
  select(c(Rank_2019, Model, RMSSE_2019))

# Calculate RMSSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_algarve_slide, tourism_algarve_until2022) %>%
  filter(.model %in% best_models_fc_algarve_slide) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSSE_2022 = RMSSE) %>%
  select(c(Rank_2022, Model, RMSSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSSE", "Rank", "RMSSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSSE: 2010-2019 vs. 2010-2022</span>", digits = 4, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

#### RMSSE Development by including more Years in Time Series

**All Models**

```{r}
# Plot development of RMSSE for period 2010-2022
accuracy_algarve_slide %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2010-2019
accuracy_algarve_slide %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2020-2022
accuracy_algarve_slide %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")
```

**Each Model once**

```{r}
# Plot development of RMSSE for period 2010-2022
accuracy_algarve_slide %>%
  filter(Model %in% best_models_fc_algarve_slide) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2010-2019
accuracy_algarve_slide %>%
  filter(Model %in% best_models_fc_algarve_slide) %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2020-2022
accuracy_algarve_slide %>%
  filter(Model %in% best_models_fc_algarve_slide) %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  xlab("Until Year") +
  ylab("RMSSE")
```

## Alentejo

### Recursive Window Cross-Validation

#### Time series Cross-Validation & Seasonal Strength Test

```{r}
# Cross-Validation to create Training sets
data_stretch_alentejo <- tourism_alentejo_until2022 %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Testing for Seasonal Strength
data_stretch_alentejo %>%
  features(Overnight_Stays, unitroot_nsdiffs) %>%
  group_by(Region) %>%
  summarise(Mean_nsdiffs = (mean(nsdiffs))) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Seasonal Strength Test</span>", align = "lc") %>%
  column_spec(2, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

#### Fitting Models and one-step ahead Forecasts

```{r}
# Fit models
fit_alentejo_stretch <- data_stretch_alentejo %>%
  model(
    SNaive = SNAIVE(Overnight_Stays),
    Drift_STL = decomposition_model(STL(Overnight_Stays),RW(season_adjust ~ drift())),
    Naive = NAIVE(Overnight_Stays),
    TSLM = TSLM(Overnight_Stays ~ trend() + season()),
    ETS_auto = ETS(Overnight_Stays),
    HWA = ETS(Overnight_Stays ~ error("A") + trend("A") + season("A")),
    ARIMA_auto = ARIMA(Overnight_Stays),
		ARIMA_d1D1 = ARIMA(Overnight_Stays ~ pdq(d=1) + PDQ(D=1)),
		ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)),
		Prophet = fable.prophet::prophet(Overnight_Stays ~ season(period = 12)),
		SNaive_log = SNAIVE(log(Overnight_Stays)),
    Drift_STL_log = decomposition_model(STL(log(Overnight_Stays)),RW(season_adjust ~ drift())),
    Naive_log = NAIVE(log(Overnight_Stays)),
    TSLM_log = TSLM(log(Overnight_Stays) ~ trend() + season()),
    ETS_auto_log = ETS(log(Overnight_Stays)),
		HWA_log = ETS(log(Overnight_Stays) ~ error("A") + trend("A") + season("A")),
    ARIMA_auto_log = ARIMA(log(Overnight_Stays)),
    ARIMA_d1D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=1) + PDQ(D=1)),
    ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)),
    Prophet_log = fable.prophet::prophet(log(Overnight_Stays) ~ season(period = 12))
    )

# Perform a one-step ahead Forecast
fc_alentejo_stretch <- fit_alentejo_stretch %>% forecast(h=1)
```

#### Forecast Errors

```{r}
# Calculate forecast error per observation and model
error_fc_alentejo_stretch <- merge(tourism_alentejo_until2022, fc_alentejo_stretch, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays-Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)

# Show table
error_fc_alentejo_stretch %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Forecast Error per Observation and Model</span>", digits = 2, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

```{r}
# Show Forecast error in Plot: 2000-2022
error_fc_alentejo_stretch %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_alentejo_until2022, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2000-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2010-2022
tourism_alentejo_from2010 <- tourism_alentejo_until2022 %>%
  filter(year(Month) >= 2010)

error_fc_alentejo_stretch %>%
  filter(year(Month) >= 2010) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_alentejo_from2010, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2010-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2019-2022
tourism_alentejo_from2019 <- tourism_alentejo_until2022 %>%
  filter(year(Month) >= 2019)

error_fc_alentejo_stretch %>%
  filter(year(Month) >= 2019) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_alentejo_from2019, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2019-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2020-2022
tourism_alentejo_from2020 <- tourism_alentejo_until2022 %>%
  filter(year(Month) >= 2020)

error_fc_alentejo_stretch %>%
  filter(year(Month) >= 2020) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_alentejo_from2020, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2020-2022") +
  ylab("Overnight_Stays")
```

#### Change of RMSE: 2010-2019 vs. 2010-2022

**All Models**

Note: In the following, "All Models" means that all 20 models are shown. Each model appears twice: With the original & with the log-transformed variable.

```{r}
# Calculate RMSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_alentejo_stretch, tourism_alentejo_until2019) %>%
  arrange(RMSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSE_2019 = RMSE) %>%
  select(c(Rank_2019, Model, RMSE_2019))

# Calculate RMSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_alentejo_stretch, tourism_alentejo_until2022) %>%
  arrange(RMSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSE_2022 = RMSE) %>%
  select(c(Rank_2022, Model, RMSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSE", "Rank", "RMSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE: 2010-2019 vs. 2010-2022</span>", format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

**Each Model once**

Note: In the following, "Each Model once" means that each model appears only once: Either with the original or with the log-transformed variable (depending on the lowest RMSE for the 2010-2022 Forecasts).

```{r}
# Save best models according to the RMSE of Forecasts from 2010-2022
best_models_fc_alentejo_stretch <- c("ARIMA_d0D1_log", "Drift_STL", "ARIMA_d1D1", "ARIMA_auto_log", "HWA", "ETS_auto_log", "Naive", "Prophet_log", "TSLM_log", "SNaive")

# Calculate RMSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_alentejo_stretch, tourism_alentejo_until2019) %>%
  filter(.model %in% best_models_fc_alentejo_stretch) %>%
  arrange(RMSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSE_2019 = RMSE) %>%
  select(c(Rank_2019, Model, RMSE_2019))

# Calculate RMSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_alentejo_stretch, tourism_alentejo_until2022) %>%
  filter(.model %in% best_models_fc_alentejo_stretch) %>%
  arrange(RMSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSE_2022 = RMSE) %>%
  select(c(Rank_2022, Model, RMSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSE", "Rank", "RMSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE: 2010-2019 vs. 2010-2022</span>", format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

#### RMSE Development  by including more Years in Time Series

```{r, warning = FALSE}
# Compute RMSE and RMSSE for 2010 and create tibble
tourism_until_i <- tourism_alentejo_until2022 %>%
    filter(year(Month) <= 2010)

accuracy_alentejo_stretch <- accuracy(fc_alentejo_stretch, tourism_until_i) %>%
  select(c(.model, RMSE, RMSSE)) %>%
  mutate(Until_Year = 2010)

# Create tsibble of summarized RMSE and RMSSE, beginning in 2010 and including more years
for (i in 2011:2022){
  tourism_until_i <- tourism_alentejo_until2022 %>%
    filter(year(Month) <= i)

  accuracy_next_year <- accuracy(fc_alentejo_stretch, tourism_until_i) %>%
    select(c(.model, RMSE, RMSSE)) %>%
    mutate(Until_Year = i)

  accuracy_alentejo_stretch <- rbind(accuracy_alentejo_stretch, accuracy_next_year)
}

rm(accuracy_next_year, tourism_until_i) # remove variables from R environment

accuracy_alentejo_stretch <- accuracy_alentejo_stretch %>%
  rename(Model = .model) %>%
  select(c(Until_Year, Model, RMSE, RMSSE)) %>%
  as_tsibble(key = Model, index = Until_Year)

# Show table
accuracy_alentejo_stretch %>%
  mutate(across(RMSE, ~ format(.x, big.mark = ","))) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Development of RMSE and RMSSE by including more Years in Time Series</span>", digits = 2, align = "cccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

**All Models**

```{r}
# Plot development of RMSE for period 2010-2022
accuracy_alentejo_stretch %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2010-2019
accuracy_alentejo_stretch %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2020-2022
accuracy_alentejo_stretch %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Change of RMSE by including 2020 in the time series
RMSE_until2019 <- accuracy_alentejo_stretch %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2019) %>%
  rename(RMSE_2019 = RMSE)

RMSE_until2020 <- accuracy_alentejo_stretch %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2020) %>%
  rename(RMSE_2020 = RMSE)

merge(RMSE_until2019, RMSE_until2020, by = "Model") %>%
  select(!c(Until_Year.x, Until_Year.y)) %>%
  mutate(Diff_abs = RMSE_2020 - RMSE_2019) %>%
  mutate(Diff_rel = Diff_abs/(RMSE_2020 - Diff_abs)) %>%
  arrange(Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE by including 2020 in Time Series</span>", format.args = list(big.mark = ","), digits = c(0,2,2,2,4), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

rm(RMSE_until2019, RMSE_until2020) # remove variables from R environment
```

**Each Model once**

```{r}
# Plot development of RMSE for period 2010-2022
accuracy_alentejo_stretch %>%
  filter(Model %in% best_models_fc_alentejo_stretch) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2010-2019
accuracy_alentejo_stretch %>%
  filter(Model %in% best_models_fc_alentejo_stretch) %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2020-2022
accuracy_alentejo_stretch %>%
  filter(Model %in% best_models_fc_alentejo_stretch) %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  xlab("Until Year") +
  ylab("RMSE")

# Change of RMSE by including 2020 in the time series
RMSE_until2019 <- accuracy_alentejo_stretch %>%
  filter(Model %in% best_models_fc_alentejo_stretch) %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2019) %>%
  rename(RMSE_2019 = RMSE)

RMSE_until2020 <- accuracy_alentejo_stretch %>%
  filter(Model %in% best_models_fc_alentejo_stretch) %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2020) %>%
  rename(RMSE_2020 = RMSE)

merge(RMSE_until2019, RMSE_until2020, by = "Model") %>%
  select(!c(Until_Year.x, Until_Year.y)) %>%
  mutate(Diff_abs = RMSE_2020 - RMSE_2019) %>%
  mutate(Diff_rel = Diff_abs/(RMSE_2020 - Diff_abs)) %>%
  arrange(Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE by including 2020 in Time Series</span>", format.args = list(big.mark = ","), digits = c(0,2,2,2,4), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

rm(RMSE_until2019, RMSE_until2020) # remove variables from R environment
```

#### RMSE per Year

**All Models**

```{r}
# Calculate RMSE per year and save as tsibble
rmse_pyear_alentejo_stretch <- error_fc_alentejo_stretch %>%
  mutate(Year = year(Month)) %>%
  index_by(Year) %>%
  group_by(Model) %>%
  summarise(RMSE = (mean(Forecast_Error**2))**0.5)

# Create Plot for 2010-2022
rmse_pyear_alentejo_stretch %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2010-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2))

# Create Plot for 2020-2022
rmse_pyear_alentejo_stretch %>%
  filter(Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2))

# Show RMSE of 2020 with Difference to previous Year
rmse_pyear_alentejo_stretch %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2020) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2020 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2021 with Difference to previous Year
rmse_pyear_alentejo_stretch %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2021) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2021 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2022 with Difference to previous Year
rmse_pyear_alentejo_stretch %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2022) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2022 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)
```

**Each Model once**

```{r}
# Create Plot for 2010-2022
rmse_pyear_alentejo_stretch %>%
  filter(Model %in% best_models_fc_alentejo_stretch) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2010-2022")

# Create Plot for 2020-2022
rmse_pyear_alentejo_stretch %>%
  filter(Model %in% best_models_fc_alentejo_stretch) %>%
  filter(Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2020-2022")

# Show RMSE of 2020 with Difference to previous Year
rmse_pyear_alentejo_stretch %>%
  filter(Model %in% best_models_fc_alentejo_stretch) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2020) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2020 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2021 with Difference to previous Year
rmse_pyear_alentejo_stretch %>%
  filter(Model %in% best_models_fc_alentejo_stretch) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2021) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2021 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2022 with Difference to previous Year
rmse_pyear_alentejo_stretch %>%
  filter(Model %in% best_models_fc_alentejo_stretch) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2022) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2022 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)
```

#### Change of RMSSE: 2010-2019 vs. 2010-2022

**All Models**

```{r}
# Calculate RMSSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_alentejo_stretch, tourism_alentejo_until2019) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSSE_2019 = RMSSE) %>%
  select(c(Rank_2019, Model, RMSSE_2019))

# Calculate RMSSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_alentejo_stretch, tourism_alentejo_until2022) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSSE_2022 = RMSSE) %>%
  select(c(Rank_2022, Model, RMSSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSSE", "Rank", "RMSSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSSE: 2010-2019 vs. 2010-2022</span>", digits = 4, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

**Each Model once**

```{r}
# Calculate RMSSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_alentejo_stretch, tourism_alentejo_until2019) %>%
  filter(.model %in% best_models_fc_alentejo_stretch) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSSE_2019 = RMSSE) %>%
  select(c(Rank_2019, Model, RMSSE_2019))

# Calculate RMSSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_alentejo_stretch, tourism_alentejo_until2022) %>%
  filter(.model %in% best_models_fc_alentejo_stretch) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSSE_2022 = RMSSE) %>%
  select(c(Rank_2022, Model, RMSSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSSE", "Rank", "RMSSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSSE: 2010-2019 vs. 2010-2022</span>", digits = 4, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

#### RMSSE Development by including more Years in Time Series

**All Models**

```{r}
# Plot development of RMSSE for period 2010-2022
accuracy_alentejo_stretch %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2010-2019
accuracy_alentejo_stretch %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2020-2022
accuracy_alentejo_stretch %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")
```

**Each Model once**

```{r}
# Plot development of RMSSE for period 2010-2022
accuracy_alentejo_stretch %>%
  filter(Model %in% best_models_fc_alentejo_stretch) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2010-2019
accuracy_alentejo_stretch %>%
  filter(Model %in% best_models_fc_alentejo_stretch) %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2020-2022
accuracy_alentejo_stretch %>%
  filter(Model %in% best_models_fc_alentejo_stretch) %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  xlab("Until Year") +
  ylab("RMSSE")
```

### Rolling Window Cross-Validation

#### Time series Cross-Validation & Seasonal Strength Test

```{r}
# Cross-Validation with sliding Window to create Training sets
data_slide_alentejo <- tourism_alentejo_until2022 %>%
  slide_tsibble (.size = 120, .step = 1) %>%
  filter (.id != max(.id))

# Testing for Seasonal Strength
data_slide_alentejo %>%
  features(Overnight_Stays, unitroot_nsdiffs) %>%
  group_by(Region) %>%
  summarise(Mean_nsdiffs = (mean(nsdiffs))) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Seasonal Strength Test</span>", align = "lc") %>%
  column_spec(2, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

#### Fitting Models and one-step ahead Forecasts

```{r}
# Fit models
fit_alentejo_slide <- data_slide_alentejo %>%
  model(
    SNaive = SNAIVE(Overnight_Stays),
    Drift_STL = decomposition_model(STL(Overnight_Stays),RW(season_adjust ~ drift())),
    Naive = NAIVE(Overnight_Stays),
    TSLM = TSLM(Overnight_Stays ~ trend() + season()),
    ETS_auto = ETS(Overnight_Stays),
    HWA = ETS(Overnight_Stays ~ error("A") + trend("A") + season("A")),
    ARIMA_auto = ARIMA(Overnight_Stays),
    ARIMA_d1D1 = ARIMA(Overnight_Stays ~ pdq(d=1) + PDQ(D=1)),
    ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)),
    Prophet = fable.prophet::prophet(Overnight_Stays ~ season(period = 12)),
    SNaive_log = SNAIVE(log(Overnight_Stays)),
    Drift_STL_log = decomposition_model(STL(log(Overnight_Stays)),RW(season_adjust ~ drift())),
    Naive_log = NAIVE(log(Overnight_Stays)),
    TSLM_log = TSLM(log(Overnight_Stays) ~ trend() + season()),
    ETS_auto_log = ETS(log(Overnight_Stays)),
    HWA_log = ETS(log(Overnight_Stays) ~ error("A") + trend("A") + season("A")),
    ARIMA_auto_log = ARIMA(log(Overnight_Stays)),
    ARIMA_d1D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=1) + PDQ(D=1)),
    ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)),
    Prophet_log = fable.prophet::prophet(log(Overnight_Stays) ~ season(period = 12))
    )

# Perform a one-step ahead Forecast
fc_alentejo_slide <- fit_alentejo_slide %>% forecast(h=1)
```

#### Forecast Errors

```{r}
# Calculate forecast error per observation and model
error_fc_alentejo_slide <- merge(tourism_alentejo_until2022, fc_alentejo_slide, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays-Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)

# Show table
error_fc_alentejo_slide %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Forecast Error per Observation and Model</span>", digits = 2, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

```{r}
# Show Point Forecasts in Plot: 2000-2022
error_fc_alentejo_slide %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_alentejo_until2022, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2000-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2010-2022
error_fc_alentejo_slide %>%
  filter(year(Month) >= 2010) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_alentejo_from2010, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2010-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2019-2022
error_fc_alentejo_slide %>%
  filter(year(Month) >= 2019) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_alentejo_from2019, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2019-2022") +
  ylab("Overnight_Stays")
```

```{r}
# Show Point Forecasts in Plot: 2020-2022
error_fc_alentejo_slide %>%
  filter(year(Month) >= 2020) %>%
  autoplot(Point_Forecast) +
  theme(legend.position = "bottom") +
  autolayer(tourism_alentejo_from2020, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts of Models: 2020-2022") +
  ylab("Overnight_Stays")
```

#### Change of RMSE: 2010-2019 vs. 2010-2022

**All Models**

```{r}
# Calculate RMSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_alentejo_slide, tourism_alentejo_until2019) %>%
  arrange(RMSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSE_2019 = RMSE) %>%
  select(c(Rank_2019, Model, RMSE_2019))

# Calculate RMSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_alentejo_slide, tourism_alentejo_until2022) %>%
  arrange(RMSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSE_2022 = RMSE) %>%
  select(c(Rank_2022, Model, RMSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSE", "Rank", "RMSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE: 2010-2019 vs. 2010-2022</span>", format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

**Each Model once**

```{r}
# Save best models according to the RMSE of Forecasts from 2010-2022
best_models_fc_alentejo_slide <- c("ARIMA_d0D1", "Drift_STL", "ARIMA_d1D1", "ARIMA_auto", "HWA_log", "ETS_auto_log", "Naive", "Prophet_log", "TSLM_log", "SNaive")

# Calculate RMSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_alentejo_slide, tourism_alentejo_until2019) %>%
  filter(.model %in% best_models_fc_alentejo_slide) %>%
  arrange(RMSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSE_2019 = RMSE) %>%
  select(c(Rank_2019, Model, RMSE_2019))

# Calculate RMSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_alentejo_slide, tourism_alentejo_until2022) %>%
  filter(.model %in% best_models_fc_alentejo_slide) %>%
  arrange(RMSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSE_2022 = RMSE) %>%
  select(c(Rank_2022, Model, RMSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSE", "Rank", "RMSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE: 2010-2019 vs. 2010-2022</span>", format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

#### RMSE Development  by including more Years in Time Series

```{r, warning = FALSE}
# Compute RMSE and RMSSE for 2010 and create tibble
tourism_until_i <- tourism_alentejo_until2022 %>%
    filter(year(Month) <= 2010)

accuracy_alentejo_slide <- accuracy(fc_alentejo_slide, tourism_until_i) %>%
  select(c(.model, RMSE, RMSSE)) %>%
  mutate(Until_Year = 2010)

# Create tsibble of summarized RMSE and RMSSE, beginning in 2010 and including more years
for (i in 2011:2022){
  tourism_until_i <- tourism_alentejo_until2022 %>%
    filter(year(Month) <= i)

  accuracy_next_year <- accuracy(fc_alentejo_slide, tourism_until_i) %>%
    select(c(.model, RMSE, RMSSE)) %>%
    mutate(Until_Year = i)

  accuracy_alentejo_slide <- rbind(accuracy_alentejo_slide, accuracy_next_year)
}

rm(accuracy_next_year, tourism_until_i) # remove variables from R environment

accuracy_alentejo_slide <- accuracy_alentejo_slide %>%
  rename(Model = .model) %>%
  select(c(Until_Year, Model, RMSE, RMSSE)) %>%
  as_tsibble(key = Model, index = Until_Year)

# Show table
accuracy_alentejo_slide %>%
  mutate(across(RMSE, ~ format(.x, big.mark = ","))) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Development of RMSE and RMSSE by including more Years in Time Series</span>", digits = 2, align = "cccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F) %>%
  scroll_box(height = "400px")
```

**All Models**

```{r}
# Plot development of RMSE for period 2010-2022
accuracy_alentejo_slide %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2010-2019
accuracy_alentejo_slide %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2020-2022
accuracy_alentejo_slide %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSE")

# Change of RMSE by including 2020 in the time series
RMSE_until2019 <- accuracy_alentejo_slide %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2019) %>%
  rename(RMSE_2019 = RMSE)

RMSE_until2020 <- accuracy_alentejo_slide %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2020) %>%
  rename(RMSE_2020 = RMSE)

merge(RMSE_until2019, RMSE_until2020, by = "Model") %>%
  select(!c(Until_Year.x, Until_Year.y)) %>%
  mutate(Diff_abs = RMSE_2020 - RMSE_2019) %>%
  mutate(Diff_rel = Diff_abs/(RMSE_2020 - Diff_abs)) %>%
  arrange(Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE by including 2020 in Time Series</span>", format.args = list(big.mark = ","), digits = c(0,2,2,2,4), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

rm(RMSE_until2019, RMSE_until2020) # remove variables from R environment
```

**Each Model once**

```{r}
# Plot development of RMSE for period 2010-2022
accuracy_alentejo_slide %>%
  filter(Model %in% best_models_fc_alentejo_slide) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2010-2019
accuracy_alentejo_slide %>%
  filter(Model %in% best_models_fc_alentejo_slide) %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  xlab("Until Year") +
  ylab("RMSE")

# Zooming in 2020-2022
accuracy_alentejo_slide %>%
  filter(Model %in% best_models_fc_alentejo_slide) %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  xlab("Until Year") +
  ylab("RMSE")

# Change of RMSE by including 2020 in the time series
RMSE_until2019 <- accuracy_alentejo_slide %>%
  filter(Model %in% best_models_fc_alentejo_slide) %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2019) %>%
  rename(RMSE_2019 = RMSE)

RMSE_until2020 <- accuracy_alentejo_slide %>%
  filter(Model %in% best_models_fc_alentejo_slide) %>%
  select(!RMSSE) %>%
  filter(Until_Year == 2020) %>%
  rename(RMSE_2020 = RMSE)

merge(RMSE_until2019, RMSE_until2020, by = "Model") %>%
  select(!c(Until_Year.x, Until_Year.y)) %>%
  mutate(Diff_abs = RMSE_2020 - RMSE_2019) %>%
  mutate(Diff_rel = Diff_abs/(RMSE_2020 - Diff_abs)) %>%
  arrange(Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSE by including 2020 in Time Series</span>", format.args = list(big.mark = ","), digits = c(0,2,2,2,4), align = "lcccc") %>%
  column_spec(2:5, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)

rm(RMSE_until2019, RMSE_until2020) # remove variables from R environment
```

#### RMSE per Year

**All Models**

```{r}
# Calculate RMSE per year and save as tsibble
rmse_pyear_alentejo_slide <- error_fc_alentejo_slide %>%
  mutate(Year = year(Month)) %>%
  index_by(Year) %>%
  group_by(Model) %>%
  summarise(RMSE = (mean(Forecast_Error**2))**0.5)

# Create Plot for 2010-2022
rmse_pyear_alentejo_slide %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2010-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2))

# Create Plot for 2020-2022
rmse_pyear_alentejo_slide %>%
  filter(Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2))

# Show RMSE of 2020 with Difference to previous Year
rmse_pyear_alentejo_slide %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2020) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2020 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2021 with Difference to previous Year
rmse_pyear_alentejo_slide %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2021) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2021 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2022 with Difference to previous Year
rmse_pyear_alentejo_slide %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2022) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2022 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)
```

**Each Model once**

```{r}
# Create Plot for 2010-2022
rmse_pyear_alentejo_slide %>%
  filter(Model %in% best_models_fc_alentejo_slide) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2010-2022")

# Create Plot for 2020-2022
rmse_pyear_alentejo_slide %>%
  filter(Model %in% best_models_fc_alentejo_slide) %>%
  filter(Year > 2019) %>%
  autoplot(RMSE) +
  ggtitle("RMSE per Year: 2020-2022")

# Show RMSE of 2020 with Difference to previous Year
rmse_pyear_alentejo_slide %>%
  filter(Model %in% best_models_fc_alentejo_slide) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2020) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2020 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2021 with Difference to previous Year
rmse_pyear_alentejo_slide %>%
  filter(Model %in% best_models_fc_alentejo_slide) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2021) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2021 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)

# Show RMSE of 2022 with Difference to previous Year
rmse_pyear_alentejo_slide %>%
  filter(Model %in% best_models_fc_alentejo_slide) %>%
  mutate(RMSE_Diff_abs = difference(RMSE,1)) %>%
  filter(Year == 2022) %>%
  as_tibble() %>%
  select(!Year) %>%
  mutate(RMSE_Diff_rel = RMSE_Diff_abs / (RMSE - RMSE_Diff_abs)) %>%
  arrange(RMSE_Diff_rel) %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of 2022 with Difference to previous Year</span>", format.args = list(big.mark = ","), digits = c(0,2,2,4), align = "lccc") %>%
  column_spec(2:4, border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), fixed_thead = T, full_width = F)
```

#### Change of RMSSE: 2010-2019 vs. 2010-2022

**All Models**

```{r}
# Calculate RMSSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_alentejo_slide, tourism_alentejo_until2019) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSSE_2019 = RMSSE) %>%
  select(c(Rank_2019, Model, RMSSE_2019))

# Calculate RMSSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_alentejo_slide, tourism_alentejo_until2022) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSSE_2022 = RMSSE) %>%
  select(c(Rank_2022, Model, RMSSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSSE", "Rank", "RMSSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSSE: 2010-2019 vs. 2010-2022</span>", digits = 4, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

**Each Model once**

```{r}
# Calculate RMSSE for 2010-2019 and according Rank
accuracy_2019 <- accuracy(fc_alentejo_slide, tourism_alentejo_until2019) %>%
  filter(.model %in% best_models_fc_alentejo_slide) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2019 = row_number()) %>%
  rename(Model = .model, RMSSE_2019 = RMSSE) %>%
  select(c(Rank_2019, Model, RMSSE_2019))

# Calculate RMSSE for 2010-2022 and according Rank
accuracy_2022 <- accuracy(fc_alentejo_slide, tourism_alentejo_until2022) %>%
  filter(.model %in% best_models_fc_alentejo_slide) %>%
  arrange(RMSSE) %>%
  mutate(Rank_2022 = row_number()) %>%
  rename(Model = .model, RMSSE_2022 = RMSSE) %>%
  select(c(Rank_2022, Model, RMSSE_2022))

# Merge in one table
summary <- merge(accuracy_2019, accuracy_2022, by = "Model") %>% arrange(Rank_2022)
colnames(summary) <- c("Model", "Rank", "RMSSE", "Rank", "RMSSE")

# Show table
summary %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Change of RMSSE: 2010-2019 vs. 2010-2022</span>", digits = 4, format.args = list(big.mark = ","), align = "lcccc") %>%
  column_spec(c(2, 4), border_left = T) %>%
  column_spec(c(2, 4), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F) %>%
  add_header_above(c(" " = 1, "2010-2019" = 2, "2010-2022" = 2))

rm(accuracy_2019, accuracy_2022, summary) # remove variables from R environment
```

#### RMSSE Development by including more Years in Time Series

**All Models**

```{r}
# Plot development of RMSSE for period 2010-2022
accuracy_alentejo_slide %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2010-2019
accuracy_alentejo_slide %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2020-2022
accuracy_alentejo_slide %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  guides(color = guide_legend(title = "Model", ncol = 2)) +
  xlab("Until Year") +
  ylab("RMSSE")
```

**Each Model once**

```{r}
# Plot development of RMSSE for period 2010-2022
accuracy_alentejo_slide %>%
  filter(Model %in% best_models_fc_alentejo_slide) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "2010 - 2022") +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2010-2019
accuracy_alentejo_slide %>%
  filter(Model %in% best_models_fc_alentejo_slide) %>%
  filter(Until_Year <= 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2010-2019") +
  xlab("Until Year") +
  ylab("RMSSE")

# Zooming in 2020-2022
accuracy_alentejo_slide %>%
  filter(Model %in% best_models_fc_alentejo_slide) %>%
  filter(Until_Year > 2019) %>%
  autoplot(RMSSE) +
  ggtitle("RMSSE Development by including more Years in Time Series", subtitle = "Zooming in 2020-2022") +
  xlab("Until Year") +
  ylab("RMSSE")
```

# Improving Forecasting Accuracy after Data Anomalies

## Madeira

### Outliers: March 2020 to June 2021

#### Outlier Adjustment to Mean per Month of previous 20 years

```{r}
# Calculate mean per month of 20 years before outliers
madeira_mean_month_20years <- tourism_madeira_until2022 %>%
  filter_index("Mar 2000" ~ "Feb 2020") %>%
  mutate(Month_number = month(Month)) %>%
  as_tibble() %>%
  select("Overnight_Stays", "Month_number") %>%
  group_by(Month_number) %>%
  summarize(Mean_per_Month = mean(Overnight_Stays))

# Show table
madeira_mean_month_20years %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Mean per Month of 20 Years: <br> Mar 2000 - Feb 2020</span>", digits = 2, format.args = list(big.mark = ","), align = "cc") %>%
  column_spec(c(1), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)
```

```{r}
# Save outliers from Mar 2020 to Jun 2021 in tsibble
madeira_outliers_until_jun21 <- tourism_madeira_until2022 %>%
  filter_index("Mar 2020" ~ "Jun 2021") %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(madeira_outliers_until_jun21, madeira_mean_month_20years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_madeira_until_feb20 <- tourism_madeira_until2022 %>%
  filter_index("Jan 2000" ~ "Feb 2020")

tourism_madeira_from_jul21 <- tourism_madeira_until2022 %>%
  filter_index("Jul 2021" ~ "Jun 2022")

tourism_madeira_adjusted_outliers <- bind_rows(tourism_madeira_until_feb20, adjusted_outliers, tourism_madeira_from_jul21)

# Show adjusted time series
tourism_madeira_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_madeira_adjusted_outliers <- tourism_madeira_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_madeira_stretch_adjusted_outliers <- data_stretch_madeira_adjusted_outliers %>%
  model(ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_madeira_stretch_adjusted_outliers <- fit_madeira_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_madeira_stretch_adjusted_outliers <- merge(tourism_madeira_adjusted_outliers, fc_madeira_stretch_adjusted_outliers, by = "Month") %>%
  filter(.model == "ARIMA_d0D1") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_20years <- error_fc_madeira_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_20years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_madeira_stretch_adjusted_outliers <- error_fc_madeira_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_madeira_stretch_orig_outliers <- error_fc_madeira_stretch %>%
  filter(Model == "ARIMA_d0D1") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_madeira_stretch_adjusted_outliers, error_fc_madeira_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_madeira_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment to Mean per Month of previous 10 years

```{r}
# Calculate mean per month of 10 years before outliers
madeira_mean_month_10years <- tourism_madeira_until2022 %>%
  filter_index("Mar 2010" ~ "Feb 2020") %>%
  mutate(Month_number = month(Month)) %>%
  as_tibble() %>%
  select("Overnight_Stays", "Month_number") %>%
  group_by(Month_number) %>%
  summarize(Mean_per_Month = mean(Overnight_Stays))

# Show table
madeira_mean_month_10years %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Mean per Month of 10 Years: <br> Mar 2010 - Feb 2020</span>", digits = 2, format.args = list(big.mark = ","), align = "cc") %>%
  column_spec(c(1), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)
```

```{r}
# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(madeira_outliers_until_jun21, madeira_mean_month_10years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_madeira_adjusted_outliers <- bind_rows(tourism_madeira_until_feb20, adjusted_outliers, tourism_madeira_from_jul21)

# Show adjusted time series
tourism_madeira_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_madeira_adjusted_outliers <- tourism_madeira_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_madeira_stretch_adjusted_outliers <- data_stretch_madeira_adjusted_outliers %>%
  model(ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_madeira_stretch_adjusted_outliers <- fit_madeira_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_madeira_stretch_adjusted_outliers <- merge(tourism_madeira_adjusted_outliers, fc_madeira_stretch_adjusted_outliers, by = "Month") %>%
  filter(.model == "ARIMA_d0D1") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_10years <- error_fc_madeira_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_10years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_madeira_stretch_adjusted_outliers <- error_fc_madeira_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_madeira_stretch_orig_outliers <- error_fc_madeira_stretch %>%
  filter(Model == "ARIMA_d0D1") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_madeira_stretch_adjusted_outliers, error_fc_madeira_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_madeira_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment to Mean per Month of previous 5 years

```{r}
# Calculate mean per month of 5 years before outliers
madeira_mean_month_5years <- tourism_madeira_until2022 %>%
  filter_index("Mar 2015" ~ "Feb 2020") %>%
  mutate(Month_number = month(Month)) %>%
  as_tibble() %>%
  select("Overnight_Stays", "Month_number") %>%
  group_by(Month_number) %>%
  summarize(Mean_per_Month = mean(Overnight_Stays))

# Show table
madeira_mean_month_5years %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Mean per Month of 5 Years: <br> Mar 2015 - Feb 2020</span>", digits = 2, format.args = list(big.mark = ","), align = "cc") %>%
  column_spec(c(1), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)
```

```{r}
# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(madeira_outliers_until_jun21, madeira_mean_month_5years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_madeira_adjusted_outliers <- bind_rows(tourism_madeira_until_feb20, adjusted_outliers, tourism_madeira_from_jul21)

# Show adjusted time series
tourism_madeira_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_madeira_adjusted_outliers <- tourism_madeira_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_madeira_stretch_adjusted_outliers <- data_stretch_madeira_adjusted_outliers %>%
  model(ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_madeira_stretch_adjusted_outliers <- fit_madeira_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_madeira_stretch_adjusted_outliers <- merge(tourism_madeira_adjusted_outliers, fc_madeira_stretch_adjusted_outliers, by = "Month") %>%
  filter(.model == "ARIMA_d0D1") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_5years <- error_fc_madeira_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_5years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_madeira_stretch_adjusted_outliers <- error_fc_madeira_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_madeira_stretch_orig_outliers <- error_fc_madeira_stretch %>%
  filter(Model == "ARIMA_d0D1") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_madeira_stretch_adjusted_outliers, error_fc_madeira_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_madeira_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 20 years

```{r}
# Save tourism data until 2022 with month number
tourism_madeira_until2022_month_number <- tourism_madeira_until2022 %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_madeira_until2022_month_number, madeira_mean_month_20years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Jun 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_madeira_adjusted_outliers <- bind_rows(tourism_madeira_until_feb20, adjusted_outliers, tourism_madeira_from_jul21)

# Show adjusted time series
tourism_madeira_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_madeira_adjusted_outliers <- tourism_madeira_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_madeira_stretch_adjusted_outliers <- data_stretch_madeira_adjusted_outliers %>%
  model(ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_madeira_stretch_adjusted_outliers <- fit_madeira_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_madeira_stretch_adjusted_outliers <- merge(tourism_madeira_adjusted_outliers, fc_madeira_stretch_adjusted_outliers, by = "Month") %>%
  filter(.model == "ARIMA_d0D1") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_20years <- error_fc_madeira_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_20years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_madeira_stretch_adjusted_outliers <- error_fc_madeira_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_madeira_stretch_orig_outliers <- error_fc_madeira_stretch %>%
  filter(Model == "ARIMA_d0D1") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_madeira_stretch_adjusted_outliers, error_fc_madeira_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_madeira_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 10 years

```{r}
# Save tourism data until 2022 with month number
tourism_madeira_until2022_month_number <- tourism_madeira_until2022 %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_madeira_until2022_month_number, madeira_mean_month_10years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Jun 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_madeira_adjusted_outliers <- bind_rows(tourism_madeira_until_feb20, adjusted_outliers, tourism_madeira_from_jul21)

# Show adjusted time series
tourism_madeira_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_madeira_adjusted_outliers <- tourism_madeira_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_madeira_stretch_adjusted_outliers <- data_stretch_madeira_adjusted_outliers %>%
  model(ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_madeira_stretch_adjusted_outliers <- fit_madeira_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_madeira_stretch_adjusted_outliers <- merge(tourism_madeira_adjusted_outliers, fc_madeira_stretch_adjusted_outliers, by = "Month") %>%
  filter(.model == "ARIMA_d0D1") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_10years <- error_fc_madeira_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_10years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_madeira_stretch_adjusted_outliers <- error_fc_madeira_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_madeira_stretch_orig_outliers <- error_fc_madeira_stretch %>%
  filter(Model == "ARIMA_d0D1") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_madeira_stretch_adjusted_outliers, error_fc_madeira_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_madeira_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 5 years

```{r}
# Save tourism data until 2022 with month number
tourism_madeira_until2022_month_number <- tourism_madeira_until2022 %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_madeira_until2022_month_number, madeira_mean_month_5years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Jun 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_madeira_adjusted_outliers <- bind_rows(tourism_madeira_until_feb20, adjusted_outliers, tourism_madeira_from_jul21)

# Show adjusted time series
tourism_madeira_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_madeira_adjusted_outliers <- tourism_madeira_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_madeira_stretch_adjusted_outliers <- data_stretch_madeira_adjusted_outliers %>%
  model(ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_madeira_stretch_adjusted_outliers <- fit_madeira_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_madeira_stretch_adjusted_outliers <- merge(tourism_madeira_adjusted_outliers, fc_madeira_stretch_adjusted_outliers, by = "Month") %>%
  filter(.model == "ARIMA_d0D1") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_5years <- error_fc_madeira_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_5years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_madeira_stretch_adjusted_outliers <- error_fc_madeira_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_madeira_stretch_orig_outliers <- error_fc_madeira_stretch %>%
  filter(Model == "ARIMA_d0D1") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_madeira_stretch_adjusted_outliers, error_fc_madeira_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_madeira_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Summary of Results

```{r}
# RMSE with original outliers
RMSE_original_outliers <- error_fc_madeira_stretch %>%
  filter(Model == "ARIMA_d0D1") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(RMSE_original_Outliers = (mean(Forecast_Error**2))**0.5)

# Merge all calculated RMSE's
RMSE_adjusted_outliers_summary_1 <- cbind(RMSE_original_outliers, RMSE_adjusted_outliers_20years, RMSE_adjusted_outliers_10years, RMSE_adjusted_outliers_5years,RMSE_adjusted_outliers_50perc_20years, RMSE_adjusted_outliers_50perc_10years, RMSE_adjusted_outliers_50perc_5years)

rownames(RMSE_adjusted_outliers_summary_1) <- "RMSE"

RMSE_adjusted_outliers_summary_1 <- as.data.frame(t(head(RMSE_adjusted_outliers_summary_1)))

# Show df
RMSE_adjusted_outliers_summary_1 %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of various Approaches for Madeira: <br> Forecasts July 2021 - June 2022</span>", digits = 2, format.args = list(big.mark = ","), align = "c") %>%
  column_spec(c(2), border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)
```

### Outliers: March 2020 to December 2021

#### Outlier Adjustment to Mean per Month of previous 20 years

```{r}
# Save outliers from Mar 2020 to Dec 2021 in tsibble
madeira_outliers_until_dec21 <- tourism_madeira_until2022 %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(madeira_outliers_until_dec21, madeira_mean_month_20years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_madeira_from_jan22 <- tourism_madeira_until2022 %>%
  filter_index("Jan 2022" ~ "Jun 2022")

tourism_madeira_adjusted_outliers <- bind_rows(tourism_madeira_until_feb20, adjusted_outliers, tourism_madeira_from_jan22)

# Show adjusted time series
tourism_madeira_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_madeira_adjusted_outliers <- tourism_madeira_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_madeira_stretch_adjusted_outliers <- data_stretch_madeira_adjusted_outliers %>%
  model(ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_madeira_stretch_adjusted_outliers <- fit_madeira_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_madeira_stretch_adjusted_outliers <- merge(tourism_madeira_adjusted_outliers, fc_madeira_stretch_adjusted_outliers, by = "Month") %>%
  filter(.model == "ARIMA_d0D1") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_20years <- error_fc_madeira_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_20years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_madeira_stretch_adjusted_outliers <- error_fc_madeira_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_madeira_stretch_orig_outliers <- error_fc_madeira_stretch %>%
  filter(Model == "ARIMA_d0D1") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_madeira_stretch_adjusted_outliers, error_fc_madeira_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_madeira_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment to Mean per Month of previous 10 years

```{r}
# Save outliers from Mar 2020 to Dec 2021 in tsibble
madeira_outliers_until_dec21 <- tourism_madeira_until2022 %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(madeira_outliers_until_dec21, madeira_mean_month_10years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_madeira_from_jan22 <- tourism_madeira_until2022 %>%
  filter_index("Jan 2022" ~ "Jun 2022")

tourism_madeira_adjusted_outliers <- bind_rows(tourism_madeira_until_feb20, adjusted_outliers, tourism_madeira_from_jan22)

# Show adjusted time series
tourism_madeira_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_madeira_adjusted_outliers <- tourism_madeira_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_madeira_stretch_adjusted_outliers <- data_stretch_madeira_adjusted_outliers %>%
  model(ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_madeira_stretch_adjusted_outliers <- fit_madeira_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_madeira_stretch_adjusted_outliers <- merge(tourism_madeira_adjusted_outliers, fc_madeira_stretch_adjusted_outliers, by = "Month") %>%
  filter(.model == "ARIMA_d0D1") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_10years <- error_fc_madeira_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_10years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_madeira_stretch_adjusted_outliers <- error_fc_madeira_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_madeira_stretch_orig_outliers <- error_fc_madeira_stretch %>%
  filter(Model == "ARIMA_d0D1") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_madeira_stretch_adjusted_outliers, error_fc_madeira_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_madeira_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment to Mean per Month of previous 5 years

```{r}
# Save outliers from Mar 2020 to Dec 2021 in tsibble
madeira_outliers_until_dec21 <- tourism_madeira_until2022 %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(madeira_outliers_until_dec21, madeira_mean_month_5years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_madeira_from_jan22 <- tourism_madeira_until2022 %>%
  filter_index("Jan 2022" ~ "Jun 2022")

tourism_madeira_adjusted_outliers <- bind_rows(tourism_madeira_until_feb20, adjusted_outliers, tourism_madeira_from_jan22)

# Show adjusted time series
tourism_madeira_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_madeira_adjusted_outliers <- tourism_madeira_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_madeira_stretch_adjusted_outliers <- data_stretch_madeira_adjusted_outliers %>%
  model(ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_madeira_stretch_adjusted_outliers <- fit_madeira_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_madeira_stretch_adjusted_outliers <- merge(tourism_madeira_adjusted_outliers, fc_madeira_stretch_adjusted_outliers, by = "Month") %>%
  filter(.model == "ARIMA_d0D1") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_5years <- error_fc_madeira_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_5years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_madeira_stretch_adjusted_outliers <- error_fc_madeira_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_madeira_stretch_orig_outliers <- error_fc_madeira_stretch %>%
  filter(Model == "ARIMA_d0D1") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_madeira_stretch_adjusted_outliers, error_fc_madeira_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_madeira_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 20 years

```{r}
# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_madeira_until2022_month_number, madeira_mean_month_20years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_madeira_adjusted_outliers <- bind_rows(tourism_madeira_until_feb20, adjusted_outliers, tourism_madeira_from_jan22)

# Show adjusted time series
tourism_madeira_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_madeira_adjusted_outliers <- tourism_madeira_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_madeira_stretch_adjusted_outliers <- data_stretch_madeira_adjusted_outliers %>%
  model(ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_madeira_stretch_adjusted_outliers <- fit_madeira_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_madeira_stretch_adjusted_outliers <- merge(tourism_madeira_adjusted_outliers, fc_madeira_stretch_adjusted_outliers, by = "Month") %>%
  filter(.model == "ARIMA_d0D1") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_20years <- error_fc_madeira_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_20years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_madeira_stretch_adjusted_outliers <- error_fc_madeira_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_madeira_stretch_orig_outliers <- error_fc_madeira_stretch %>%
  filter(Model == "ARIMA_d0D1") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_madeira_stretch_adjusted_outliers, error_fc_madeira_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_madeira_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 10 years

```{r}
# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_madeira_until2022_month_number, madeira_mean_month_10years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_madeira_adjusted_outliers <- bind_rows(tourism_madeira_until_feb20, adjusted_outliers, tourism_madeira_from_jan22)

# Show adjusted time series
tourism_madeira_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_madeira_adjusted_outliers <- tourism_madeira_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_madeira_stretch_adjusted_outliers <- data_stretch_madeira_adjusted_outliers %>%
  model(ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_madeira_stretch_adjusted_outliers <- fit_madeira_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_madeira_stretch_adjusted_outliers <- merge(tourism_madeira_adjusted_outliers, fc_madeira_stretch_adjusted_outliers, by = "Month") %>%
  filter(.model == "ARIMA_d0D1") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_10years <- error_fc_madeira_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_10years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_madeira_stretch_adjusted_outliers <- error_fc_madeira_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_madeira_stretch_orig_outliers <- error_fc_madeira_stretch %>%
  filter(Model == "ARIMA_d0D1") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_madeira_stretch_adjusted_outliers, error_fc_madeira_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_madeira_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 5 years

```{r}
# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_madeira_until2022_month_number, madeira_mean_month_5years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_madeira_adjusted_outliers <- bind_rows(tourism_madeira_until_feb20, adjusted_outliers, tourism_madeira_from_jan22)

# Show adjusted time series
tourism_madeira_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_madeira_adjusted_outliers <- tourism_madeira_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_madeira_stretch_adjusted_outliers <- data_stretch_madeira_adjusted_outliers %>%
  model(ARIMA_d0D1 = ARIMA(Overnight_Stays ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_madeira_stretch_adjusted_outliers <- fit_madeira_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_madeira_stretch_adjusted_outliers <- merge(tourism_madeira_adjusted_outliers, fc_madeira_stretch_adjusted_outliers, by = "Month") %>%
  filter(.model == "ARIMA_d0D1") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_5years <- error_fc_madeira_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_5years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_madeira_stretch_adjusted_outliers <- error_fc_madeira_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_madeira_stretch_orig_outliers <- error_fc_madeira_stretch %>%
  filter(Model == "ARIMA_d0D1") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_madeira_stretch_adjusted_outliers, error_fc_madeira_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_madeira_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Summary of Results

```{r}
# RMSE with original outliers
RMSE_original_outliers <- error_fc_madeira_stretch %>%
  filter(Model == "ARIMA_d0D1") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(RMSE_original_Outliers = (mean(Forecast_Error**2))**0.5)

# Merge all calculated RMSE's
RMSE_adjusted_outliers_summary_2 <- cbind(RMSE_original_outliers, RMSE_adjusted_outliers_20years, RMSE_adjusted_outliers_10years, RMSE_adjusted_outliers_5years, RMSE_adjusted_outliers_50perc_20years, RMSE_adjusted_outliers_50perc_10years, RMSE_adjusted_outliers_50perc_5years)

rownames(RMSE_adjusted_outliers_summary_2) <- "RMSE"

RMSE_adjusted_outliers_summary_2 <- as.data.frame(t(head(RMSE_adjusted_outliers_summary_2)))

# Show df
RMSE_adjusted_outliers_summary_2 %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of various Approaches for Madeira: <br> Forecasts January 2022 - June 2022</span>", digits = 2, format.args = list(big.mark = ","), align = "c") %>%
  column_spec(c(2), border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)
```

## Algarve

### Outliers: March 2020 to June 2021

#### Outlier Adjustment to Mean per Month of previous 20 years

```{r}
# Calculate mean per month of 20 years before outliers
algarve_mean_month_20years <- tourism_algarve_until2022 %>%
  filter_index("Mar 2000" ~ "Feb 2020") %>%
  mutate(Month_number = month(Month)) %>%
  as_tibble() %>%
  select("Overnight_Stays", "Month_number") %>%
  group_by(Month_number) %>%
  summarize(Mean_per_Month = mean(Overnight_Stays))

# Show table
algarve_mean_month_20years %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Mean per Month of 20 Years: <br> Mar 2000 - Feb 2020</span>", digits = 2, format.args = list(big.mark = ","), align = "cc") %>%
  column_spec(c(1), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)
```

```{r}
# Save outliers from Mar 2020 to Jun 2021 in tsibble
algarve_outliers_until_jun21 <- tourism_algarve_until2022 %>%
  filter_index("Mar 2020" ~ "Jun 2021") %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(algarve_outliers_until_jun21, algarve_mean_month_20years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_algarve_until_feb20 <- tourism_algarve_until2022 %>%
  filter_index("Jan 2000" ~ "Feb 2020")

tourism_algarve_from_jul21 <- tourism_algarve_until2022 %>%
  filter_index("Jul 2021" ~ "Jun 2022")

tourism_algarve_adjusted_outliers <- bind_rows(tourism_algarve_until_feb20, adjusted_outliers, tourism_algarve_from_jul21)

# Show adjusted time series
tourism_algarve_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_algarve_adjusted_outliers <- tourism_algarve_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_algarve_stretch_adjusted_outliers <- data_stretch_algarve_adjusted_outliers %>%
  model(ARIMA_auto = ARIMA(Overnight_Stays))

# Perform a one-step ahead Forecast
fc_algarve_stretch_adjusted_outliers <- fit_algarve_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_algarve_stretch_adjusted_outliers <- merge(tourism_algarve_adjusted_outliers, fc_algarve_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays-Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_20years <- error_fc_algarve_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_auto") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_20years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_algarve_stretch_adjusted_outliers <- error_fc_algarve_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_algarve_stretch_orig_outliers <- error_fc_algarve_stretch %>%
  filter(Model == "ARIMA_auto") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_algarve_stretch_adjusted_outliers, error_fc_algarve_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_algarve_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment to Mean per Month of previous 10 years

```{r}
# Calculate mean per month of 10 years before outliers
algarve_mean_month_10years <- tourism_algarve_until2022 %>%
  filter_index("Mar 2010" ~ "Feb 2020") %>%
  mutate(Month_number = month(Month)) %>%
  as_tibble() %>%
  select("Overnight_Stays", "Month_number") %>%
  group_by(Month_number) %>%
  summarize(Mean_per_Month = mean(Overnight_Stays))

# Show table
algarve_mean_month_10years %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Mean per Month of 10 Years: <br> Mar 2010 - Feb 2020</span>", digits = 2, format.args = list(big.mark = ","), align = "cc") %>%
  column_spec(c(1), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)
```

```{r}
# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(algarve_outliers_until_jun21, algarve_mean_month_10years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_algarve_adjusted_outliers <- bind_rows(tourism_algarve_until_feb20, adjusted_outliers, tourism_algarve_from_jul21)

# Show adjusted time series
tourism_algarve_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_algarve_adjusted_outliers <- tourism_algarve_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_algarve_stretch_adjusted_outliers <- data_stretch_algarve_adjusted_outliers %>%
  model(ARIMA_auto = ARIMA(Overnight_Stays))

# Perform a one-step ahead Forecast
fc_algarve_stretch_adjusted_outliers <- fit_algarve_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_algarve_stretch_adjusted_outliers <- merge(tourism_algarve_adjusted_outliers, fc_algarve_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_10years <- error_fc_algarve_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_auto") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_10years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_algarve_stretch_adjusted_outliers <- error_fc_algarve_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_algarve_stretch_orig_outliers <- error_fc_algarve_stretch %>%
  filter(Model == "ARIMA_auto") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_algarve_stretch_adjusted_outliers, error_fc_algarve_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_algarve_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment to Mean per Month of previous 5 years

```{r}
# Calculate mean per month of 5 years before outliers
algarve_mean_month_5years <- tourism_algarve_until2022 %>%
  filter_index("Mar 2015" ~ "Feb 2020") %>%
  mutate(Month_number = month(Month)) %>%
  as_tibble() %>%
  select("Overnight_Stays", "Month_number") %>%
  group_by(Month_number) %>%
  summarize(Mean_per_Month = mean(Overnight_Stays))

# Show table
algarve_mean_month_5years %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Mean per Month of 5 Years: <br> Mar 2015 - Feb 2020</span>", digits = 2, format.args = list(big.mark = ","), align = "cc") %>%
  column_spec(c(1), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)
```

```{r}
# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(algarve_outliers_until_jun21, algarve_mean_month_5years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_algarve_adjusted_outliers <- bind_rows(tourism_algarve_until_feb20, adjusted_outliers, tourism_algarve_from_jul21)

# Show adjusted time series
tourism_algarve_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_algarve_adjusted_outliers <- tourism_algarve_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_algarve_stretch_adjusted_outliers <- data_stretch_algarve_adjusted_outliers %>%
  model(ARIMA_auto = ARIMA(Overnight_Stays))

# Perform a one-step ahead Forecast
fc_algarve_stretch_adjusted_outliers <- fit_algarve_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_algarve_stretch_adjusted_outliers <- merge(tourism_algarve_adjusted_outliers, fc_algarve_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_5years <- error_fc_algarve_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_auto") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_5years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_algarve_stretch_adjusted_outliers <- error_fc_algarve_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_algarve_stretch_orig_outliers <- error_fc_algarve_stretch %>%
  filter(Model == "ARIMA_auto") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_algarve_stretch_adjusted_outliers, error_fc_algarve_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_algarve_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 20 years

```{r}
# Save tourism data until 2022 with month number
tourism_algarve_until2022_month_number <- tourism_algarve_until2022 %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_algarve_until2022_month_number, algarve_mean_month_20years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Jun 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_algarve_adjusted_outliers <- bind_rows(tourism_algarve_until_feb20, adjusted_outliers, tourism_algarve_from_jul21)

# Show adjusted time series
tourism_algarve_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_algarve_adjusted_outliers <- tourism_algarve_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_algarve_stretch_adjusted_outliers <- data_stretch_algarve_adjusted_outliers %>%
  model(ARIMA_auto = ARIMA(Overnight_Stays))

# Perform a one-step ahead Forecast
fc_algarve_stretch_adjusted_outliers <- fit_algarve_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_algarve_stretch_adjusted_outliers <- merge(tourism_algarve_adjusted_outliers, fc_algarve_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_20years <- error_fc_algarve_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_auto") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_20years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_algarve_stretch_adjusted_outliers <- error_fc_algarve_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_algarve_stretch_orig_outliers <- error_fc_algarve_stretch %>%
  filter(Model == "ARIMA_auto") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_algarve_stretch_adjusted_outliers, error_fc_algarve_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_algarve_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 10 years

```{r}
# Save tourism data until 2022 with month number
tourism_algarve_until2022_month_number <- tourism_algarve_until2022 %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_algarve_until2022_month_number, algarve_mean_month_10years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Jun 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_algarve_adjusted_outliers <- bind_rows(tourism_algarve_until_feb20, adjusted_outliers, tourism_algarve_from_jul21)

# Show adjusted time series
tourism_algarve_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_algarve_adjusted_outliers <- tourism_algarve_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_algarve_stretch_adjusted_outliers <- data_stretch_algarve_adjusted_outliers %>%
  model(ARIMA_auto = ARIMA(Overnight_Stays))

# Perform a one-step ahead Forecast
fc_algarve_stretch_adjusted_outliers <- fit_algarve_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_algarve_stretch_adjusted_outliers <- merge(tourism_algarve_adjusted_outliers, fc_algarve_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_10years <- error_fc_algarve_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_auto") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_10years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_algarve_stretch_adjusted_outliers <- error_fc_algarve_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_algarve_stretch_orig_outliers <- error_fc_algarve_stretch %>%
  filter(Model == "ARIMA_auto") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_algarve_stretch_adjusted_outliers, error_fc_algarve_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_algarve_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 5 years

```{r}
# Save tourism data until 2022 with month number
tourism_algarve_until2022_month_number <- tourism_algarve_until2022 %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_algarve_until2022_month_number, algarve_mean_month_5years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Jun 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_algarve_adjusted_outliers <- bind_rows(tourism_algarve_until_feb20, adjusted_outliers, tourism_algarve_from_jul21)

# Show adjusted time series
tourism_algarve_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_algarve_adjusted_outliers <- tourism_algarve_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_algarve_stretch_adjusted_outliers <- data_stretch_algarve_adjusted_outliers %>%
  model(ARIMA_auto = ARIMA(Overnight_Stays))

# Perform a one-step ahead Forecast
fc_algarve_stretch_adjusted_outliers <- fit_algarve_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_algarve_stretch_adjusted_outliers <- merge(tourism_algarve_adjusted_outliers, fc_algarve_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_5years <- error_fc_algarve_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_auto") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_5years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_algarve_stretch_adjusted_outliers <- error_fc_algarve_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_algarve_stretch_orig_outliers <- error_fc_algarve_stretch %>%
  filter(Model == "ARIMA_auto") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_algarve_stretch_adjusted_outliers, error_fc_algarve_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_algarve_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Summary of Results

```{r}
# RMSE with original outliers
RMSE_original_outliers <- error_fc_algarve_stretch %>%
  filter(Model == "ARIMA_auto") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(RMSE_original_Outliers = (mean(Forecast_Error**2))**0.5)

# Merge all calculated RMSE's
RMSE_adjusted_outliers_summary_3 <- cbind(RMSE_original_outliers, RMSE_adjusted_outliers_20years, RMSE_adjusted_outliers_10years, RMSE_adjusted_outliers_5years, RMSE_adjusted_outliers_50perc_20years, RMSE_adjusted_outliers_50perc_10years, RMSE_adjusted_outliers_50perc_5years)

rownames(RMSE_adjusted_outliers_summary_3) <- "RMSE"

RMSE_adjusted_outliers_summary_3 <- as.data.frame(t(head(RMSE_adjusted_outliers_summary_3)))

# Show df
RMSE_adjusted_outliers_summary_3 %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of various Approaches for Algarve: <br> Forecasts July 2021 - June 2022</span>", digits = 2, format.args = list(big.mark = ","), align = "c") %>%
  column_spec(c(2), border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)
```

### Outliers: March 2020 to December 2021

#### Outlier Adjustment to Mean per Month of previous 20 years

```{r}
# Save outliers from Mar 2020 to Dec 2021 in tsibble
algarve_outliers_until_dec21 <- tourism_algarve_until2022 %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(algarve_outliers_until_dec21, algarve_mean_month_20years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_algarve_from_jan22 <- tourism_algarve_until2022 %>%
  filter_index("Jan 2022" ~ "Jun 2022")

tourism_algarve_adjusted_outliers <- bind_rows(tourism_algarve_until_feb20, adjusted_outliers, tourism_algarve_from_jan22)

# Show adjusted time series
tourism_algarve_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_algarve_adjusted_outliers <- tourism_algarve_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_algarve_stretch_adjusted_outliers <- data_stretch_algarve_adjusted_outliers %>%
  model(ARIMA_auto = ARIMA(Overnight_Stays))

# Perform a one-step ahead Forecast
fc_algarve_stretch_adjusted_outliers <- fit_algarve_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_algarve_stretch_adjusted_outliers <- merge(tourism_algarve_adjusted_outliers, fc_algarve_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_20years <- error_fc_algarve_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_auto") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_20years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_algarve_stretch_adjusted_outliers <- error_fc_algarve_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_algarve_stretch_orig_outliers <- error_fc_algarve_stretch %>%
  filter(Model == "ARIMA_auto") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_algarve_stretch_adjusted_outliers, error_fc_algarve_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_algarve_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment to Mean per Month of previous 10 years

```{r}
# Save outliers from Mar 2020 to Dec 2021 in tsibble
algarve_outliers_until_dec21 <- tourism_algarve_until2022 %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(algarve_outliers_until_dec21, algarve_mean_month_10years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_algarve_from_jan22 <- tourism_algarve_until2022 %>%
  filter_index("Jan 2022" ~ "Jun 2022")

tourism_algarve_adjusted_outliers <- bind_rows(tourism_algarve_until_feb20, adjusted_outliers, tourism_algarve_from_jan22)

# Show adjusted time series
tourism_algarve_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_algarve_adjusted_outliers <- tourism_algarve_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_algarve_stretch_adjusted_outliers <- data_stretch_algarve_adjusted_outliers %>%
  model(ARIMA_auto = ARIMA(Overnight_Stays))

# Perform a one-step ahead Forecast
fc_algarve_stretch_adjusted_outliers <- fit_algarve_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_algarve_stretch_adjusted_outliers <- merge(tourism_algarve_adjusted_outliers, fc_algarve_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_10years <- error_fc_algarve_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_auto") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_10years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_algarve_stretch_adjusted_outliers <- error_fc_algarve_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_algarve_stretch_orig_outliers <- error_fc_algarve_stretch %>%
  filter(Model == "ARIMA_auto") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_algarve_stretch_adjusted_outliers, error_fc_algarve_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_algarve_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment to Mean per Month of previous 5 years

```{r}
# Save outliers from Mar 2020 to Dec 2021 in tsibble
algarve_outliers_until_dec21 <- tourism_algarve_until2022 %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(algarve_outliers_until_dec21, algarve_mean_month_5years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_algarve_from_jan22 <- tourism_algarve_until2022 %>%
  filter_index("Jan 2022" ~ "Jun 2022")

tourism_algarve_adjusted_outliers <- bind_rows(tourism_algarve_until_feb20, adjusted_outliers, tourism_algarve_from_jan22)

# Show adjusted time series
tourism_algarve_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_algarve_adjusted_outliers <- tourism_algarve_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_algarve_stretch_adjusted_outliers <- data_stretch_algarve_adjusted_outliers %>%
  model(ARIMA_auto = ARIMA(Overnight_Stays))

# Perform a one-step ahead Forecast
fc_algarve_stretch_adjusted_outliers <- fit_algarve_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_algarve_stretch_adjusted_outliers <- merge(tourism_algarve_adjusted_outliers, fc_algarve_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_5years <- error_fc_algarve_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_auto") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_5years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_algarve_stretch_adjusted_outliers <- error_fc_algarve_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_algarve_stretch_orig_outliers <- error_fc_algarve_stretch %>%
  filter(Model == "ARIMA_auto") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_algarve_stretch_adjusted_outliers, error_fc_algarve_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_algarve_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 20 years

```{r}
# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_algarve_until2022_month_number, algarve_mean_month_20years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_algarve_adjusted_outliers <- bind_rows(tourism_algarve_until_feb20, adjusted_outliers, tourism_algarve_from_jan22)

# Show adjusted time series
tourism_algarve_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_algarve_adjusted_outliers <- tourism_algarve_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_algarve_stretch_adjusted_outliers <- data_stretch_algarve_adjusted_outliers %>%
  model(ARIMA_auto = ARIMA(Overnight_Stays))

# Perform a one-step ahead Forecast
fc_algarve_stretch_adjusted_outliers <- fit_algarve_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_algarve_stretch_adjusted_outliers <- merge(tourism_algarve_adjusted_outliers, fc_algarve_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_20years <- error_fc_algarve_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_auto") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_20years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_algarve_stretch_adjusted_outliers <- error_fc_algarve_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_algarve_stretch_orig_outliers <- error_fc_algarve_stretch %>%
  filter(Model == "ARIMA_auto") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_algarve_stretch_adjusted_outliers, error_fc_algarve_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_algarve_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 10 years

```{r}
# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_algarve_until2022_month_number, algarve_mean_month_10years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_algarve_adjusted_outliers <- bind_rows(tourism_algarve_until_feb20, adjusted_outliers, tourism_algarve_from_jan22)

# Show adjusted time series
tourism_algarve_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_algarve_adjusted_outliers <- tourism_algarve_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_algarve_stretch_adjusted_outliers <- data_stretch_algarve_adjusted_outliers %>%
  model(ARIMA_auto = ARIMA(Overnight_Stays))

# Perform a one-step ahead Forecast
fc_algarve_stretch_adjusted_outliers <- fit_algarve_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_algarve_stretch_adjusted_outliers <- merge(tourism_algarve_adjusted_outliers, fc_algarve_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_10years <- error_fc_algarve_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_auto") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_10years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_algarve_stretch_adjusted_outliers <- error_fc_algarve_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_algarve_stretch_orig_outliers <- error_fc_algarve_stretch %>%
  filter(Model == "ARIMA_auto") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_algarve_stretch_adjusted_outliers, error_fc_algarve_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_algarve_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 5 years

```{r}
# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_algarve_until2022_month_number, algarve_mean_month_20years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_algarve_adjusted_outliers <- bind_rows(tourism_algarve_until_feb20, adjusted_outliers, tourism_algarve_from_jan22)

# Show adjusted time series
tourism_algarve_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_algarve_adjusted_outliers <- tourism_algarve_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_algarve_stretch_adjusted_outliers <- data_stretch_algarve_adjusted_outliers %>%
  model(ARIMA_auto = ARIMA(Overnight_Stays))

# Perform a one-step ahead Forecast
fc_algarve_stretch_adjusted_outliers <- fit_algarve_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_algarve_stretch_adjusted_outliers <- merge(tourism_algarve_adjusted_outliers, fc_algarve_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_5years <- error_fc_algarve_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_auto") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_5years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_algarve_stretch_adjusted_outliers <- error_fc_algarve_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_algarve_stretch_orig_outliers <- error_fc_algarve_stretch %>%
  filter(Model == "ARIMA_auto") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_algarve_stretch_adjusted_outliers, error_fc_algarve_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_algarve_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Summary of Results

```{r}
# RMSE with original outliers
error_fc_algarve_stretch %>%
  filter(Model == "ARIMA_auto") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(RMSE_original_Outliers = (mean(Forecast_Error**2))**0.5)

# Merge all calculated RMSE's
RMSE_adjusted_outliers_summary_4 <- cbind(RMSE_original_outliers, RMSE_adjusted_outliers_20years, RMSE_adjusted_outliers_10years, RMSE_adjusted_outliers_5years, RMSE_adjusted_outliers_50perc_20years, RMSE_adjusted_outliers_50perc_10years, RMSE_adjusted_outliers_50perc_5years)

rownames(RMSE_adjusted_outliers_summary_4) <- "RMSE"

RMSE_adjusted_outliers_summary_4 <- as.data.frame(t(head(RMSE_adjusted_outliers_summary_4)))

# Show df
RMSE_adjusted_outliers_summary_4 %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of various Approaches for Algarve: <br> Forecasts January 2022 - June 2022</span>", digits = 2, format.args = list(big.mark = ","), align = "c") %>%
  column_spec(c(2), border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)
```

## Alentejo

### Outliers: March 2020 to June 2021

#### Outlier Adjustment to Mean per Month of previous 20 years

```{r}
# Calculate mean per month of 20 years before outliers
alentejo_mean_month_20years <- tourism_alentejo_until2022 %>%
  filter_index("Mar 2000" ~ "Feb 2020") %>%
  mutate(Month_number = month(Month)) %>%
  as_tibble() %>%
  select("Overnight_Stays", "Month_number") %>%
  group_by(Month_number) %>%
  summarize(Mean_per_Month = mean(Overnight_Stays))

# Show table
alentejo_mean_month_20years %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Mean per Month of 20 Years: <br> Mar 2000 - Feb 2020</span>", digits = 2, format.args = list(big.mark = ","), align = "cc") %>%
  column_spec(c(1), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)
```

```{r}
# Save outliers from Mar 2020 to Jun 2021 in tsibble
alentejo_outliers_until_jun21 <- tourism_alentejo_until2022 %>%
  filter_index("Mar 2020" ~ "Jun 2021") %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(alentejo_outliers_until_jun21, alentejo_mean_month_20years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_alentejo_until_feb20 <- tourism_alentejo_until2022 %>%
  filter_index("Jan 2000" ~ "Feb 2020")

tourism_alentejo_from_jul21 <- tourism_alentejo_until2022 %>%
  filter_index("Jul 2021" ~ "Jun 2022")

tourism_alentejo_adjusted_outliers <- bind_rows(tourism_alentejo_until_feb20, adjusted_outliers, tourism_alentejo_from_jul21)

# Show adjusted time series
tourism_alentejo_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_alentejo_adjusted_outliers <- tourism_alentejo_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_alentejo_stretch_adjusted_outliers <- data_stretch_alentejo_adjusted_outliers %>%
  model(ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_alentejo_stretch_adjusted_outliers <- fit_alentejo_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_alentejo_stretch_adjusted_outliers <- merge(tourism_alentejo_adjusted_outliers, fc_alentejo_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_20years <- error_fc_alentejo_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_20years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_alentejo_stretch_adjusted_outliers <- error_fc_alentejo_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_alentejo_stretch_orig_outliers <- error_fc_alentejo_stretch %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_alentejo_stretch_adjusted_outliers, error_fc_alentejo_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_alentejo_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment to Mean per Month of previous 10 years

```{r}
# Calculate mean per month of 10 years before outliers
alentejo_mean_month_10years <- tourism_alentejo_until2022 %>%
  filter_index("Mar 2010" ~ "Feb 2020") %>%
  mutate(Month_number = month(Month)) %>%
  as_tibble() %>%
  select("Overnight_Stays", "Month_number") %>%
  group_by(Month_number) %>%
  summarize(Mean_per_Month = mean(Overnight_Stays))

# Show table
alentejo_mean_month_10years %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Mean per Month of 10 Years: <br> Mar 2010 - Feb 2020</span>", digits = 2, format.args = list(big.mark = ","), align = "cc") %>%
  column_spec(c(1), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)
```

```{r}
# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(alentejo_outliers_until_jun21, alentejo_mean_month_10years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_alentejo_adjusted_outliers <- bind_rows(tourism_alentejo_until_feb20, adjusted_outliers, tourism_alentejo_from_jul21)

# Show adjusted time series
tourism_alentejo_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_alentejo_adjusted_outliers <- tourism_alentejo_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_alentejo_stretch_adjusted_outliers <- data_stretch_alentejo_adjusted_outliers %>%
  model(ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1))    )

# Perform a one-step ahead Forecast
fc_alentejo_stretch_adjusted_outliers <- fit_alentejo_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_alentejo_stretch_adjusted_outliers <- merge(tourism_alentejo_adjusted_outliers, fc_alentejo_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_10years <- error_fc_alentejo_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_10years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_alentejo_stretch_adjusted_outliers <- error_fc_alentejo_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_alentejo_stretch_orig_outliers <- error_fc_alentejo_stretch %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_alentejo_stretch_adjusted_outliers, error_fc_alentejo_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_alentejo_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment to Mean per Month of previous 5 years

```{r}
# Calculate mean per month of 5 years before outliers
alentejo_mean_month_5years <- tourism_alentejo_until2022 %>%
  filter_index("Mar 2015" ~ "Feb 2020") %>%
  mutate(Month_number = month(Month)) %>%
  as_tibble() %>%
  select("Overnight_Stays", "Month_number") %>%
  group_by(Month_number) %>%
  summarize(Mean_per_Month = mean(Overnight_Stays))

# Show table
alentejo_mean_month_5years %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Mean per Month of 5 Years: <br> Mar 2015 - Feb 2020</span>", digits = 2, format.args = list(big.mark = ","), align = "cc") %>%
  column_spec(c(1), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)
```

```{r}
# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(alentejo_outliers_until_jun21, alentejo_mean_month_5years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_alentejo_adjusted_outliers <- bind_rows(tourism_alentejo_until_feb20, adjusted_outliers, tourism_alentejo_from_jul21)

# Show adjusted time series
tourism_alentejo_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_alentejo_adjusted_outliers <- tourism_alentejo_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_alentejo_stretch_adjusted_outliers <- data_stretch_alentejo_adjusted_outliers %>%
  model(ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_alentejo_stretch_adjusted_outliers <- fit_alentejo_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_alentejo_stretch_adjusted_outliers <- merge(tourism_alentejo_adjusted_outliers, fc_alentejo_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_5years <- error_fc_alentejo_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_5years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_alentejo_stretch_adjusted_outliers <- error_fc_alentejo_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_alentejo_stretch_orig_outliers <- error_fc_alentejo_stretch %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_alentejo_stretch_adjusted_outliers, error_fc_alentejo_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_alentejo_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 20 years

```{r}
# Save tourism data until 2022 with month number
tourism_alentejo_until2022_month_number <- tourism_alentejo_until2022 %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_alentejo_until2022_month_number, alentejo_mean_month_20years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Jun 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_alentejo_adjusted_outliers <- bind_rows(tourism_alentejo_until_feb20, adjusted_outliers, tourism_alentejo_from_jul21)

# Show adjusted time series
tourism_alentejo_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_alentejo_adjusted_outliers <- tourism_alentejo_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_alentejo_stretch_adjusted_outliers <- data_stretch_alentejo_adjusted_outliers %>%
  model(ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_alentejo_stretch_adjusted_outliers <- fit_alentejo_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_alentejo_stretch_adjusted_outliers <- merge(tourism_alentejo_adjusted_outliers, fc_alentejo_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_20years <- error_fc_alentejo_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_20years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_alentejo_stretch_adjusted_outliers <- error_fc_alentejo_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_alentejo_stretch_orig_outliers <- error_fc_alentejo_stretch %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_alentejo_stretch_adjusted_outliers, error_fc_alentejo_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_alentejo_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 10 years

```{r}
# Save tourism data until 2022 with month number
tourism_alentejo_until2022_month_number <- tourism_alentejo_until2022 %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_alentejo_until2022_month_number, alentejo_mean_month_10years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Jun 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_alentejo_adjusted_outliers <- bind_rows(tourism_alentejo_until_feb20, adjusted_outliers, tourism_alentejo_from_jul21)

# Show adjusted time series
tourism_alentejo_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_alentejo_adjusted_outliers <- tourism_alentejo_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_alentejo_stretch_adjusted_outliers <- data_stretch_alentejo_adjusted_outliers %>%
  model(ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_alentejo_stretch_adjusted_outliers <- fit_alentejo_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_alentejo_stretch_adjusted_outliers <- merge(tourism_alentejo_adjusted_outliers, fc_alentejo_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_10years <- error_fc_alentejo_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_10years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_alentejo_stretch_adjusted_outliers <- error_fc_alentejo_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_alentejo_stretch_orig_outliers <- error_fc_alentejo_stretch %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_alentejo_stretch_adjusted_outliers, error_fc_alentejo_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_alentejo_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 5 years

```{r}
# Save tourism data until 2022 with month number
tourism_alentejo_until2022_month_number <- tourism_alentejo_until2022 %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_alentejo_until2022_month_number, alentejo_mean_month_5years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Jun 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_alentejo_adjusted_outliers <- bind_rows(tourism_alentejo_until_feb20, adjusted_outliers, tourism_alentejo_from_jul21)

# Show adjusted time series
tourism_alentejo_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_alentejo_adjusted_outliers <- tourism_alentejo_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_alentejo_stretch_adjusted_outliers <- data_stretch_alentejo_adjusted_outliers %>%
  model(ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_alentejo_stretch_adjusted_outliers <- fit_alentejo_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_alentejo_stretch_adjusted_outliers <- merge(tourism_alentejo_adjusted_outliers, fc_alentejo_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_5years <- error_fc_alentejo_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_5years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_alentejo_stretch_adjusted_outliers <- error_fc_alentejo_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_alentejo_stretch_orig_outliers <- error_fc_alentejo_stretch %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_alentejo_stretch_adjusted_outliers, error_fc_alentejo_stretch_orig_outliers) %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_alentejo_from_jul21, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Summary of Results

```{r}
# RMSE with original outliers
RMSE_original_outliers <- error_fc_alentejo_stretch %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  filter_index("Jul 2021" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(RMSE_original_Outliers = (mean(Forecast_Error**2))**0.5)

# Merge all calculated RMSE's
RMSE_adjusted_outliers_summary_5 <- cbind(RMSE_original_outliers, RMSE_adjusted_outliers_20years, RMSE_adjusted_outliers_10years, RMSE_adjusted_outliers_5years, RMSE_adjusted_outliers_50perc_20years, RMSE_adjusted_outliers_50perc_10years, RMSE_adjusted_outliers_50perc_5years)

rownames(RMSE_adjusted_outliers_summary_5) <- "RMSE"

RMSE_adjusted_outliers_summary_5 <- as.data.frame(t(head(RMSE_adjusted_outliers_summary_5)))

# Show df
RMSE_adjusted_outliers_summary_5 %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of various Approaches for Alentejo: <br> Forecasts July 2021 - June 2022</span>", digits = 2, format.args = list(big.mark = ","), align = "c") %>%
  column_spec(c(2), border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)
```

### Outliers: March 2020 to December 2021

#### Outlier Adjustment to Mean per Month of previous 20 years

```{r}
# Save outliers from Mar 2020 to Dec 2021 in tsibble
alentejo_outliers_until_dec21 <- tourism_alentejo_until2022 %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(alentejo_outliers_until_dec21, alentejo_mean_month_20years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_alentejo_from_jan22 <- tourism_alentejo_until2022 %>%
  filter_index("Jan 2022" ~ "Jun 2022")

tourism_alentejo_adjusted_outliers <- bind_rows(tourism_alentejo_until_feb20, adjusted_outliers, tourism_alentejo_from_jan22)

# Show adjusted time series
tourism_alentejo_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_alentejo_adjusted_outliers <- tourism_alentejo_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_alentejo_stretch_adjusted_outliers <- data_stretch_alentejo_adjusted_outliers %>%
  model(ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_alentejo_stretch_adjusted_outliers <- fit_alentejo_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_alentejo_stretch_adjusted_outliers <- merge(tourism_alentejo_adjusted_outliers, fc_alentejo_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays-Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_20years <- error_fc_alentejo_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_20years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_alentejo_stretch_adjusted_outliers <- error_fc_alentejo_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_alentejo_stretch_orig_outliers <- error_fc_alentejo_stretch %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_alentejo_stretch_adjusted_outliers, error_fc_alentejo_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_alentejo_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment to Mean per Month of previous 10 years

```{r}
# Save outliers from Mar 2020 to Dec 2021 in tsibble
alentejo_outliers_until_dec21 <- tourism_alentejo_until2022 %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(alentejo_outliers_until_dec21, alentejo_mean_month_10years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_alentejo_from_jan22 <- tourism_alentejo_until2022 %>%
  filter_index("Jan 2022" ~ "Jun 2022")

tourism_alentejo_adjusted_outliers <- bind_rows(tourism_alentejo_until_feb20, adjusted_outliers, tourism_alentejo_from_jan22)

# Show adjusted time series
tourism_alentejo_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_alentejo_adjusted_outliers <- tourism_alentejo_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_alentejo_stretch_adjusted_outliers <- data_stretch_alentejo_adjusted_outliers %>%
  model(ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_alentejo_stretch_adjusted_outliers <- fit_alentejo_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_alentejo_stretch_adjusted_outliers <- merge(tourism_alentejo_adjusted_outliers, fc_alentejo_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays-Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_10years <- error_fc_alentejo_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_10years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_alentejo_stretch_adjusted_outliers <- error_fc_alentejo_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_alentejo_stretch_orig_outliers <- error_fc_alentejo_stretch %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_alentejo_stretch_adjusted_outliers, error_fc_alentejo_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_alentejo_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment to Mean per Month of previous 5 years

```{r}
# Save outliers from Mar 2020 to Dec 2021 in tsibble
alentejo_outliers_until_dec21 <- tourism_alentejo_until2022 %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Month_number = month(Month))

# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(alentejo_outliers_until_dec21, alentejo_mean_month_5years, by = "Month_number") %>%
  select(Region, Month, Mean_per_Month) %>%
  rename(Overnight_Stays = Mean_per_Month) %>%
  as_tsibble(key = Region, index = Month)

# Create tsibble of whole time series with adjusted outliers
tourism_alentejo_from_jan22 <- tourism_alentejo_until2022 %>%
  filter_index("Jan 2022" ~ "Jun 2022")

tourism_alentejo_adjusted_outliers <- bind_rows(tourism_alentejo_until_feb20, adjusted_outliers, tourism_alentejo_from_jan22)

# Show adjusted time series
tourism_alentejo_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_alentejo_adjusted_outliers <- tourism_alentejo_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_alentejo_stretch_adjusted_outliers <- data_stretch_alentejo_adjusted_outliers %>%
  model(ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_alentejo_stretch_adjusted_outliers <- fit_alentejo_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_alentejo_stretch_adjusted_outliers <- merge(tourism_alentejo_adjusted_outliers, fc_alentejo_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays-Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_5years <- error_fc_alentejo_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_Outliers_5years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_alentejo_stretch_adjusted_outliers <- error_fc_alentejo_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_alentejo_stretch_orig_outliers <- error_fc_alentejo_stretch %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_alentejo_stretch_adjusted_outliers, error_fc_alentejo_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_alentejo_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 20 years

```{r}
# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_alentejo_until2022_month_number, alentejo_mean_month_20years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_alentejo_adjusted_outliers <- bind_rows(tourism_alentejo_until_feb20, adjusted_outliers, tourism_alentejo_from_jan22)

# Show adjusted time series
tourism_alentejo_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_alentejo_adjusted_outliers <- tourism_alentejo_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_alentejo_stretch_adjusted_outliers <- data_stretch_alentejo_adjusted_outliers %>%
  model(ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_alentejo_stretch_adjusted_outliers <- fit_alentejo_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_alentejo_stretch_adjusted_outliers <- merge(tourism_alentejo_adjusted_outliers, fc_alentejo_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_20years <- error_fc_alentejo_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_20years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_alentejo_stretch_adjusted_outliers <- error_fc_alentejo_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_alentejo_stretch_orig_outliers <- error_fc_alentejo_stretch %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_alentejo_stretch_adjusted_outliers, error_fc_alentejo_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_alentejo_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 10 years

```{r}
# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_alentejo_until2022_month_number, alentejo_mean_month_10years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_alentejo_adjusted_outliers <- bind_rows(tourism_alentejo_until_feb20, adjusted_outliers, tourism_alentejo_from_jan22)

# Show adjusted time series
tourism_alentejo_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_alentejo_adjusted_outliers <- tourism_alentejo_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_alentejo_stretch_adjusted_outliers <- data_stretch_alentejo_adjusted_outliers %>%
  model(ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_alentejo_stretch_adjusted_outliers <- fit_alentejo_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_alentejo_stretch_adjusted_outliers <- merge(tourism_alentejo_adjusted_outliers, fc_alentejo_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_10years <- error_fc_alentejo_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_10years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_alentejo_stretch_adjusted_outliers <- error_fc_alentejo_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_alentejo_stretch_orig_outliers <- error_fc_alentejo_stretch %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_alentejo_stretch_adjusted_outliers, error_fc_alentejo_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_alentejo_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Outlier Adjustment by 50% to Mean per Month of previous 5 years

```{r}
# Calculate adjusted outliers and save in tsibble
adjusted_outliers <- merge(tourism_alentejo_until2022_month_number, alentejo_mean_month_5years, by = "Month_number") %>%
  as_tsibble(key = Region, index = Month) %>%
  filter_index("Mar 2020" ~ "Dec 2021") %>%
  mutate(Overnight_Stays = 0.5*Overnight_Stays + 0.5*Mean_per_Month)

# Create tsibble of whole time series with adjusted outliers
tourism_alentejo_adjusted_outliers <- bind_rows(tourism_alentejo_until_feb20, adjusted_outliers, tourism_alentejo_from_jan22)

# Show adjusted time series
tourism_alentejo_adjusted_outliers %>%
  autoplot(Overnight_Stays) +
  ggtitle("Time Series with adjusted Outliers")
```

```{r}
# Perform forecasting competition with stretch tsibble based on adjusted outliers

# Cross-Validation with stretching Window to create Training sets
data_stretch_alentejo_adjusted_outliers <- tourism_alentejo_adjusted_outliers %>%
  stretch_tsibble(.init = 120, .step = 1) %>%
  filter (.id != max(.id))

# Fit models
fit_alentejo_stretch_adjusted_outliers <- data_stretch_alentejo_adjusted_outliers %>%
  model(ARIMA_d0D1_log = ARIMA(log(Overnight_Stays) ~ pdq(d=0) + PDQ(D=1)))

# Perform a one-step ahead Forecast
fc_alentejo_stretch_adjusted_outliers <- fit_alentejo_stretch_adjusted_outliers %>% forecast(h=1)
```

```{r}
# Calculate forecast error per observation
error_fc_alentejo_stretch_adjusted_outliers <- merge(tourism_alentejo_adjusted_outliers, fc_alentejo_stretch_adjusted_outliers, by = "Month") %>%
  select(Month,Overnight_Stays.x, .model, .mean) %>%
  rename(Point_Forecast = .mean, Overnight_Stays = Overnight_Stays.x, Model = .model) %>%
  mutate(Forecast_Error = Overnight_Stays - Point_Forecast) %>%
  as_tsibble(index = Month, key = Model)
```

```{r}
# RMSE with adjusted outliers
RMSE_adjusted_outliers_50perc_5years <- error_fc_alentejo_stretch_adjusted_outliers %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(Adj_outliers_50perc_5years = (mean(Forecast_Error**2))**0.5)

# Show Point Forecasts in Plot
error_fc_alentejo_stretch_adjusted_outliers <- error_fc_alentejo_stretch_adjusted_outliers %>%
  mutate(Database = "Adjusted Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

error_fc_alentejo_stretch_orig_outliers <- error_fc_alentejo_stretch %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  mutate(Database = "Original Outliers") %>%
  as_tsibble(index = "Month", key = "Database")

bind_rows(error_fc_alentejo_stretch_adjusted_outliers, error_fc_alentejo_stretch_orig_outliers) %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  autoplot(Point_Forecast) +
  autolayer(tourism_alentejo_from_jan22, .vars = Overnight_Stays) +
  ggtitle("Point Forecasts") +
  ylab("Overnight_Stays") +
  guides(color = guide_legend(title = "Database contains"))
```

#### Summary of Results

```{r}
RMSE_original_outliers <- error_fc_alentejo_stretch %>%
  filter(Model == "ARIMA_d0D1_log") %>%
  filter_index("Jan 2022" ~ "Jun 2022") %>%
  as_tibble() %>%
  summarise(RMSE_original_Outliers = (mean(Forecast_Error**2))**0.5)

# Merge all calculated RMSE's
RMSE_adjusted_outliers_summary_6 <- cbind(RMSE_original_outliers, RMSE_adjusted_outliers_20years, RMSE_adjusted_outliers_10years, RMSE_adjusted_outliers_5years, RMSE_adjusted_outliers_50perc_20years, RMSE_adjusted_outliers_50perc_10years, RMSE_adjusted_outliers_50perc_5years)

rownames(RMSE_adjusted_outliers_summary_6) <- "RMSE"

RMSE_adjusted_outliers_summary_6 <- as.data.frame(t(head(RMSE_adjusted_outliers_summary_6)))

# Show df
RMSE_adjusted_outliers_summary_6 %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>RMSE of various Approaches for Alentejo: <br> Forecasts January 2022 - June 2022</span>", digits = 2, format.args = list(big.mark = ","), align = "c") %>%
  column_spec(c(2), border_left = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = F)
```

## Overall Summary

```{r}
# Merge all summaries
RMSE_adjusted_outliers_summary_total <- cbind(RMSE_adjusted_outliers_summary_1, RMSE_adjusted_outliers_summary_2, RMSE_adjusted_outliers_summary_3, RMSE_adjusted_outliers_summary_4, RMSE_adjusted_outliers_summary_5, RMSE_adjusted_outliers_summary_6)

rownames(RMSE_adjusted_outliers_summary_total) <- c("Original_Outliers", "Adj._Outliers_Mean_20yrs", "Adj._Outliers_Mean_10_yrs", "Adj._Outliers_Mean_5yrs", "Adj._Outliers_50%_Mean_20yrs", "Adj._Outliers_50%_Mean_10yrs", "Adj_Outliers_50%_Mean_5yrs")

colnames(RMSE_adjusted_outliers_summary_total) <- c("Outliers Mar 20 - Jun 21", "Outliers Mar 20 - Dec 21", "Outliers Mar 20 - Jun 21", "Outliers Mar 20 - Dec 21", "Outliers Mar 20 - Jun 21", "Outliers Mar 20 - Dec 21")

# Show df
RMSE_adjusted_outliers_summary_total %>%
  kbl(caption = "<span style='color:black;font-size:medium;font-weight:bold'>Impact of Outlier Adjustments on RMSE - Overall Summary for all three Regions</span>", digits = 2, format.args = list(big.mark = ","), align = "cccccc") %>%
  column_spec(c(2, 4, 6), border_left = T) %>%
  column_spec(c(2, 4, 6), border_right = "2px solid lightgray") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = T) %>%
  add_header_above(c(" " = 1, "RMSE Madeira" = 2, "RMSE Algarve" = 2, "RMSE Alentejo" = 2))
```

```{r}
# Remove all Variables from R Environment which do not add Value
rm(data_stretch_alentejo_adjusted_outliers, data_stretch_algarve_adjusted_outliers, data_stretch_madeira_adjusted_outliers, error_fc_alentejo_stretch_adjusted_outliers, error_fc_algarve_stretch_adjusted_outliers, error_fc_madeira_stretch_adjusted_outliers, error_fc_alentejo_stretch_orig_outliers, error_fc_algarve_stretch_orig_outliers, error_fc_madeira_stretch_orig_outliers, fc_alentejo_stretch_adjusted_outliers, fc_algarve_stretch_adjusted_outliers, fc_madeira_stretch_adjusted_outliers, RMSE_adjusted_outliers_10years, RMSE_adjusted_outliers_20years, RMSE_adjusted_outliers_50perc_10years, RMSE_adjusted_outliers_50perc_20years, RMSE_adjusted_outliers_50perc_5years, RMSE_adjusted_outliers_5years, RMSE_original_outliers)
```